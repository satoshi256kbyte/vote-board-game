name: CD (Development)

on:
  workflow_run:
    workflows: ['CI']
    types:
      - completed
    branches:
      - develop
      - 'feature/**'

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-development
  cancel-in-progress: false

jobs:
  deploy-development:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    uses: ./.github/workflows/deploy-reusable.yml
    with:
      environment: development
      ci-run-id: ${{ github.event.workflow_run.id }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  e2e-tests:
    needs: deploy-development
    runs-on: ubuntu-latest
    environment: development
    if: success()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.30.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get Playwright version
        id: playwright-version
        run: |
          VERSION=$(pnpm --filter @vote-board-game/web list @playwright/test --depth=0 --json | jq -r '.[0].version')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm --filter @vote-board-game/web playwright:install

      - name: Get Vercel URL
        id: vercel-url
        run: |
          VERCEL_URL="${{ vars.VERCEL_URL }}"
          if [ -z "$VERCEL_URL" ]; then
            echo "Error: Vercel URL not found"
            exit 1
          fi
          echo "url=$VERCEL_URL" >> $GITHUB_OUTPUT
          echo "Vercel URL: $VERCEL_URL"

      - name: Run E2E tests
        run: pnpm --filter @vote-board-game/web test:e2e
        env:
          BASE_URL: ${{ steps.vercel-url.outputs.url }}
        # Note: This step will fail the job and workflow if tests fail (requirement 3.5)
        # No continue-on-error is set, ensuring test failures are properly reported

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: packages/web/playwright-report/
          retention-days: 7

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-failures
          path: packages/web/test-results/
          retention-days: 7

      - name: Update deployment summary
        if: always()
        run: |
          echo "### E2E Test Results :test_tube:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ All smoke tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the [test report artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Test URL: ${{ steps.vercel-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY

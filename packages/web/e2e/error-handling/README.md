# Error Handling E2E Tests

このディレクトリには、エラーシナリオとエッジケースのE2Eテストが含まれています。

## テストファイル

### network-errors.spec.ts

ネットワークエラーのハンドリングをテストします。

**テストケース:**

- 投票送信中のネットワーク障害シミュレーション
- 候補投稿中のネットワーク障害シミュレーション
- ゲーム詳細読み込み中のネットワーク障害シミュレーション
- ネットワークエラー後のリトライ機能

**要件:**

- 12.1: 投票中のネットワーク障害をシミュレートし、適切なエラーメッセージが表示されることを検証
- 8.2: 各テストケースが30秒以内に完了

### session-timeout.spec.ts

セッションタイムアウトのハンドリングをテストします。

**テストケース:**

- セッション期限切れ時のログインページへのリダイレクト
- 無効なトークン使用時のログインページへのリダイレクト
- セッション期限切れメッセージの表示
- セッションタイムアウト後の再ログイン

**要件:**

- 12.2: セッションタイムアウトをシミュレートし、ユーザーがログインページにリダイレクトされることを検証
- 8.2: 各テストケースが30秒以内に完了

### validation-errors.spec.ts

バリデーションエラーと404エラーのハンドリングをテストします。

**テストケース:**

- ログインフォームの必須フィールド検証
- 登録フォームのメールアドレス形式検証
- 登録フォームのパスワード一致検証
- 登録フォームのパスワード強度検証
- 候補説明文の必須フィールド検証
- 候補説明文の文字数制限検証（200文字）
- プロフィール表示名の必須フィールド検証
- 存在しないゲームへのアクセス時の404エラー表示
- 404エラーページからゲーム一覧への遷移

**要件:**

- 12.5: 必須フィールドが欠けているフォームを送信し、バリデーションエラーメッセージが表示されることを検証
- 12.4: 存在しないゲームにアクセスし、404エラーページが表示されることを検証
- 8.2: 各テストケースが30秒以内に完了

## 実行方法

### すべてのエラーハンドリングテストを実行

```bash
pnpm exec playwright test e2e/error-handling/
```

### 特定のテストファイルを実行

```bash
# ネットワークエラーテスト
pnpm exec playwright test e2e/error-handling/network-errors.spec.ts

# セッションタイムアウトテスト
pnpm exec playwright test e2e/error-handling/session-timeout.spec.ts

# バリデーションエラーテスト
pnpm exec playwright test e2e/error-handling/validation-errors.spec.ts
```

### ヘッドレスモードで実行

```bash
pnpm exec playwright test e2e/error-handling/ --headed
```

## 前提条件

- BASE_URL環境変数が設定されていること
- テスト環境のフロントエンドが起動していること
- テスト環境のAPIが利用可能であること
- Cognitoユーザープールが利用可能であること
- DynamoDBテーブルが利用可能であること

## テストデータ

各テストは以下のヘルパー関数を使用してテストデータを作成・クリーンアップします:

- `createTestUser()`: テストユーザーを作成
- `cleanupTestUser()`: テストユーザーを削除
- `createTestGame()`: テストゲームを作成
- `cleanupTestGame()`: テストゲームを削除

## エラーシミュレーション

### ネットワークエラー

`simulateNetworkError(page, urlPattern)` を使用してネットワークエラーをシミュレートします。

```typescript
await simulateNetworkError(page, '**/api/votes**');
```

### セッションタイムアウト

`context.clearCookies()` を使用してセッションタイムアウトをシミュレートします。

```typescript
await context.clearCookies();
```

## 注意事項

- テストは並列実行されるため、テストデータの競合に注意
- 各テストは独立して実行可能である必要がある
- クリーンアップ処理は必ず実行される（finally ブロック使用）
- エラーメッセージのテキストは実装に合わせて調整が必要な場合がある

# Task 6 Implementation: Authentication Flow E2E Tests

## 概要

タスク6「認証フローのテスト実装」を完了しました。ユーザー登録、ログイン、ログアウト、アクセス制限の包括的なE2Eテストを実装しました。

## 実装内容

### 1. registration.spec.ts の更新

**実装したテストケース:**

1. **有効なデータでの登録成功とログインページへのリダイレクト**
   - 有効なメールアドレスとパスワードで登録
   - ログインページへのリダイレクトを検証
   - 要件 1.1 をカバー

2. **無効なメールアドレスでの登録失敗**
   - 無効なメールアドレスでエラーメッセージが表示されることを検証

3. **弱いパスワードでの登録失敗**
   - セキュリティ要件を満たさないパスワードでエラーメッセージが表示されることを検証

4. **パスワード不一致での登録失敗**
   - パスワードと確認パスワードが一致しない場合にエラーメッセージが表示されることを検証

5. **パフォーマンステスト**
   - 登録フローが30秒以内に完了することを検証

### 2. login.spec.ts の更新

**実装したテストケース:**

1. **有効な認証情報でのログイン成功とゲーム一覧ページへのリダイレクト**
   - 有効なメールアドレスとパスワードでログイン
   - ゲーム一覧ページ (`/games`) へのリダイレクトを検証
   - 要件 1.2 をカバー

2. **無効な認証情報でのログイン失敗**
   - 存在しないユーザーでエラーメッセージが表示されることを検証
   - 要件 1.4 をカバー

3. **誤ったパスワードでのログイン失敗**
   - 正しいメールアドレスだが誤ったパスワードでエラーメッセージが表示されることを検証
   - 要件 1.4 をカバー

4. **ログアウト機能**
   - ログアウトボタンをクリックしてログインページにリダイレクトされることを検証
   - 要件 1.3 をカバー

5. **未認証でのゲーム一覧ページアクセス制限**
   - 未認証でゲーム一覧ページにアクセスしようとするとログインページにリダイレクトされることを検証
   - 要件 1.5 をカバー

6. **未認証でのプロフィールページアクセス制限**
   - 未認証でプロフィールページにアクセスしようとするとログインページにリダイレクトされることを検証
   - 要件 1.5 をカバー

7. **パフォーマンステスト**
   - ログインフローが30秒以内に完了することを検証

### 3. README.md の更新

認証テストの包括的なドキュメントを作成:

- 各テストファイルの説明
- テストケースの詳細
- 要件カバレッジの明記
- 実装状況のチェックリスト
- Page Object Pattern の説明
- Test Helpers の説明
- トラブルシューティングガイド
- デバッグ方法

## 受け入れ基準の達成状況

### ✅ 完了した受け入れ基準

- [x] `e2e/auth/registration.spec.ts`を作成
- [x] 有効なデータでの登録成功テストを実装
- [x] 無効なデータでの登録失敗テストを実装
- [x] 登録後のログインページへのリダイレクトを検証
- [x] `e2e/auth/login.spec.ts`を作成
- [x] 有効な認証情報でのログイン成功テストを実装
- [x] 無効な認証情報でのログイン失敗テストを実装
- [x] ログイン後のゲーム一覧ページへのリダイレクトを検証
- [x] ログアウト機能のテストを実装
- [x] 未認証でのアクセス制限テストを実装
- [x] 各テストケースが30秒以内に完了することを確認

## 要件カバレッジ

### Requirement 1: Authentication Flow Testing

- ✅ **1.1**: Registration with valid data redirects to login page
  - `registration.spec.ts` の「有効なデータでの登録成功」テストでカバー

- ✅ **1.2**: Login with valid credentials redirects to game list
  - `login.spec.ts` の「有効な認証情報でのログイン成功」テストでカバー

- ✅ **1.3**: Logout redirects to login page
  - `login.spec.ts` の「ログアウト機能」テストでカバー

- ✅ **1.4**: Invalid credentials show error message
  - `login.spec.ts` の「無効な認証情報でのログイン失敗」と「誤ったパスワードでのログイン失敗」テストでカバー

- ✅ **1.5**: Unauthenticated access to protected pages redirects to login
  - `login.spec.ts` の「未認証でのゲーム一覧ページアクセス制限」と「未認証でのプロフィールページアクセス制限」テストでカバー

## 使用した技術とパターン

### Page Object Pattern

テストは Page Object Pattern を使用して実装:

- **LoginPage**: ログインページの操作とアサーション
- **RegistrationPage**: 登録ページの操作とアサーション
- **GameListPage**: ゲーム一覧ページの操作とアサーション

### Test Helpers

共通のテストヘルパー関数を使用:

- `createTestUser()`: Cognitoにテストユーザーを作成
- `generateTestUser()`: 一意のテストユーザーデータを生成
- `cleanupTestUser()`: テストユーザーをクリーンアップ

### テストの独立性

各テストは独立して実行可能:

- テスト前にテストユーザーを作成
- テスト後にテストユーザーをクリーンアップ
- 他のテストに影響を与えない

## テスト実行方法

```bash
# すべての認証テストを実行
pnpm test:e2e auth/

# 登録テストのみ実行
pnpm test:e2e auth/registration.spec.ts

# ログインテストのみ実行
pnpm test:e2e auth/login.spec.ts

# ヘッドレスモードを無効にしてブラウザを表示
pnpm playwright test auth/ --headed

# デバッグモードで実行
pnpm playwright test auth/ --debug
```

## パフォーマンス

すべてのテストケースは30秒以内に完了することを検証:

- 登録フロー: < 30秒
- ログインフロー: < 30秒
- ログアウトフロー: < 30秒
- アクセス制限チェック: < 30秒

## 次のステップ

タスク6は完了しました。次のタスクは:

- **タスク7**: パスワードリセットフローのテスト実装
- **タスク8**: ゲーム閲覧と参加フローのテスト実装
- **タスク9**: 投票フローのテスト実装

## 注意事項

### パスワードリセットテストについて

パスワードリセットテストは、Cognitoから送信される確認コードを取得する必要があるため、現在スキップされています。タスク7で実装する際は、以下のいずれかのアプローチを検討する必要があります:

1. テスト専用バックエンドエンドポイント（推奨）
2. テストメールサービス（Mailhog, MailSlurp）
3. AWS SDK AdminGetUser API
4. Cognitoサービスをモック

### 環境変数

E2Eテストには以下の環境変数が必要です:

```bash
BASE_URL=http://localhost:3000  # テスト対象のURL
USER_POOL_ID=ap-northeast-1_xxx  # Cognito User Pool ID
AWS_REGION=ap-northeast-1  # AWSリージョン
```

## まとめ

タスク6「認証フローのテスト実装」を完了しました。11個のテストケースを実装し、要件1のすべての受け入れ基準をカバーしています。テストは Page Object Pattern を使用して保守性が高く、独立して実行可能で、30秒以内に完了します。

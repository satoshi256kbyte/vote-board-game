echo "ğŸ“ Running format check..."
if ! pnpm format:check; then
  echo "âŒ Format check failed"
  echo "Run 'pnpm format' to fix formatting issues"
  exit 1
fi

echo "âœ… Format check passed"
echo ""

echo "ğŸ” Running type check..."
if ! pnpm type-check; then
  echo "âŒ Type check failed"
  exit 1
fi

echo "âœ… Type check passed"
echo ""

echo "ğŸ” Running lint..."
if ! pnpm lint; then
  echo "âŒ Lint failed"
  exit 1
fi

echo "âœ… Lint passed"
echo ""

echo "ğŸ›¡ï¸  Running CDK security check (cdk-nag)..."
if ! pnpm --filter @vote-board-game/infra synth > /dev/null 2>&1; then
  echo "âŒ CDK security check failed"
  echo ""
  echo "Running synth again to show errors:"
  pnpm --filter @vote-board-game/infra synth
  exit 1
fi

echo "âœ… CDK security check passed"
echo ""

echo "ğŸ§ª Checking if tests need to run..."
# ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³
TEST_PATTERNS="packages/*/src/**/*.ts packages/*/src/**/*.tsx packages/*/test/**/*.ts **/vitest.config.ts **/tsconfig.json **/package.json pnpm-lock.yaml"

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
NEEDS_TEST=false
for pattern in $TEST_PATTERNS; do
  if echo "$CHANGED_FILES" | grep -qE "^${pattern//\*/.*}$"; then
    NEEDS_TEST=true
    break
  fi
done

if [ "$NEEDS_TEST" = true ]; then
  echo "ğŸ“ Test-related files changed, running tests..."
  if ! pnpm test; then
    echo "âŒ Tests failed"
    exit 1
  fi
  echo "âœ… Tests passed"
else
  echo "â­ï¸  No test-related files changed, skipping tests"
fi

echo ""
echo "âœ¨ All checks passed! Pushing to remote..."



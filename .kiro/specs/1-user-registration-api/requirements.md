# 要件定義書

## はじめに

本ドキュメントは、投票ボードゲームアプリケーションのユーザー登録API機能の要件を定義します。ユーザー登録APIは、新規ユーザーがアカウントを作成し、投票形式のアブストラクト・ゲームに参加できるようにします。このAPIは、認証にAmazon Cognitoを、ユーザーデータの永続化にDynamoDBを統合します。

## 用語集

- **登録API**: ユーザー登録リクエストを処理するHTTP APIエンドポイント
- **Cognitoサービス**: ユーザー認証とIDを管理するAmazon Cognitoサービス
- **ユーザーリポジトリ**: ユーザー情報のDynamoDBデータアクセス層
- **JWTトークン**: 認証済みAPIリクエストに使用されるJSON Web Token
- **リフレッシュトークン**: 新しいアクセストークンを取得するために使用される長期間有効なトークン
- **ユーザーレコード**: プロフィール情報を含むDynamoDBに保存されるユーザーエンティティ
- **メールアドレス**: ユーザーの一意の識別子として使用される有効なメールアドレス
- **ユーザー名**: ユーザーが選択する表示名（3〜20文字）
- **パスワード**: セキュリティ要件を満たす秘密の認証情報
- **アクセストークン**: API認証用の短期間有効なJWTトークン（15分）

## 要件

### 要件1: ユーザー登録エンドポイント

**ユーザーストーリー:** 新規ユーザーとして、メールアドレスとパスワードを使用してアカウントを登録し、ボードゲームの次の一手への投票に参加したい。

#### 受け入れ基準

1. 登録APIは、`/auth/register`エンドポイントでPOSTリクエストを受け付けなければならない
2. 登録リクエストを受信したとき、登録APIは、リクエストボディにemail、password、usernameフィールドが含まれていることを検証しなければならない
3. emailフィールドが欠落または空の場合、登録APIは、エラーコード`VALIDATION_ERROR`を含む400ステータスコードを返さなければならない
4. passwordフィールドが欠落または空の場合、登録APIは、エラーコード`VALIDATION_ERROR`を含む400ステータスコードを返さなければならない
5. usernameフィールドが欠落または空の場合、登録APIは、エラーコード`VALIDATION_ERROR`を含む400ステータスコードを返さなければならない

### 要件2: メールアドレスの検証

**ユーザーストーリー:** システム管理者として、有効なメールアドレスのみが登録されることを保証し、ユーザーがアカウント関連の通知を受信できるようにしたい。

#### 受け入れ基準

1. メールアドレスが提供されたとき、登録APIは、それが標準のメール形式（RFC 5322）に一致することを検証しなければならない
2. メール形式が無効な場合、登録APIは、エラーコード`VALIDATION_ERROR`とメッセージ「Invalid email format」を含む400ステータスコードを返さなければならない
3. メールアドレスがCognitoサービスに既に存在する場合、登録APIは、エラーコード`CONFLICT`とメッセージ「Email already registered」を含む409ステータスコードを返さなければならない

### 要件3: パスワードセキュリティ要件

**ユーザーストーリー:** セキュリティを重視するユーザーとして、パスワードがセキュリティ基準を満たすことを望み、アカウントが不正アクセスから保護されるようにしたい。

#### 受け入れ基準

1. 登録APIは、パスワードが少なくとも8文字の長さであることを検証しなければならない
2. 登録APIは、パスワードに少なくとも1つの大文字が含まれていることを検証しなければならない
3. 登録APIは、パスワードに少なくとも1つの小文字が含まれていることを検証しなければならない
4. 登録APIは、パスワードに少なくとも1つの数字が含まれていることを検証しなければならない
5. パスワード要件が満たされていない場合、登録APIは、エラーコード`VALIDATION_ERROR`と、どの要件が満たされていないかを示す説明メッセージを含む400ステータスコードを返さなければならない

### 要件4: ユーザー名の検証

**ユーザーストーリー:** ユーザーとして、ゲーム内で自分を表す一意のユーザー名を選択し、他のプレイヤーが自分の投票と貢献を識別できるようにしたい。

#### 受け入れ基準

1. 登録APIは、ユーザー名が3〜20文字の長さであることを検証しなければならない
2. 登録APIは、ユーザー名が英数字、ハイフン、アンダースコアのみを含むことを検証しなければならない
3. ユーザー名要件が満たされていない場合、登録APIは、エラーコード`VALIDATION_ERROR`と、ユーザー名要件を説明するメッセージを含む400ステータスコードを返さなければならない

### 要件5: Cognitoユーザーの作成

**ユーザーストーリー:** システムとして、Cognitoで認証されたユーザーIDを作成し、ユーザーがアプリケーションに安全にアクセスできるようにしたい。

#### 受け入れ基準

1. すべての検証が通過したとき、登録APIは、提供されたメールアドレスとパスワードでCognitoサービスに新しいユーザーを作成しなければならない
2. Cognitoユーザーの作成が成功したとき、登録APIは、レスポンスからuserId（Cognito subクレーム）を抽出しなければならない
3. Cognitoサービスがエラーを返した場合、登録APIは、エラーコード`INTERNAL_ERROR`を含む500ステータスコードを返さなければならない
4. 登録APIは、Cognitoユーザーをメールアドレスをusername属性として設定しなければならない

### 要件6: ユーザープロフィールの作成

**ユーザーストーリー:** 登録済みユーザーとして、プロフィール情報がシステムに保存され、ゲームや投票活動で識別されるようにしたい。

#### 受け入れ基準

1. Cognitoユーザーの作成が成功したとき、登録APIは、DynamoDBにユーザーレコードを作成しなければならない
2. ユーザーレコードは、userId（CognitoからのUUID）、email、username、createdAt（ISO 8601）、updatedAt（ISO 8601）フィールドを含まなければならない
3. ユーザーレコードは、entityTypeを「USER」に設定しなければならない
4. ユーザーレコードは、パーティションキー形式`USER#<userId>`とソートキー形式`USER#<userId>`を使用しなければならない
5. DynamoDB書き込みが失敗した場合、登録APIは、エラーをログに記録し、整合性を維持するためにCognitoユーザーの削除を試みなければならない

### 要件7: 認証トークンの生成

**ユーザーストーリー:** 新規登録ユーザーとして、登録直後に認証トークンを受け取り、追加のログイン手順なしでアプリケーションの使用を開始したい。

#### 受け入れ基準

1. ユーザー登録が正常に完了したとき、登録APIは、Cognitoサービスでユーザーを認証しなければならない
2. 登録APIは、15分の有効期限を持つアクセストークンを取得しなければならない
3. 登録APIは、長期セッション管理のためのリフレッシュトークンを取得しなければならない
4. 登録APIは、レスポンスボディに両方のトークンを返さなければならない

### 要件8: 登録成功レスポンス

**ユーザーストーリー:** クライアントアプリケーションとして、登録成功後に完全なユーザー情報とトークンを受け取り、すぐにユーザーを認証してプロフィールを表示したい。

#### 受け入れ基準

1. 登録が成功したとき、登録APIは、201ステータスコードを返さなければならない
2. レスポンスボディは、userId、email、username、accessToken、refreshToken、expiresInフィールドを含まなければならない
3. expiresInフィールドは、値900（15分を秒単位で表したもの）を含まなければならない
4. レスポンスは、Content-Type `application/json`を使用しなければならない

### 要件9: レート制限

**ユーザーストーリー:** システム管理者として、登録エンドポイントの悪用を防ぎ、正当なユーザーがシステムを利用できるようにしたい。

#### 受け入れ基準

1. 登録APIは、IPアドレスごとに1分あたり5リクエストのレート制限を適用しなければならない
2. レート制限を超えたとき、登録APIは、エラーコード`RATE_LIMIT_EXCEEDED`を含む429ステータスコードを返さなければならない
3. レスポンスは、次のリクエストが許可されるまでの秒数を示す`retryAfter`フィールドを含まなければならない

### 要件10: エラーレスポンス形式

**ユーザーストーリー:** クライアントアプリケーション開発者として、一貫したエラーレスポンスを受け取り、エラーを予測可能に処理し、ユーザーに明確なフィードバックを提供したい。

#### 受け入れ基準

1. エラーが発生したとき、登録APIは、error、message、オプションのdetailsフィールドを含むJSONレスポンスを返さなければならない
2. errorフィールドは、機械可読なエラーコードを含まなければならない
3. messageフィールドは、人間が読めるエラー説明を含まなければならない
4. 検証エラーが発生した場合、detailsフィールドは、フィールド名をエラーメッセージにマッピングするfieldsオブジェクトを含まなければならない

### 要件11: CORS設定

**ユーザーストーリー:** Webアプリケーションとして、ブラウザから登録APIを呼び出し、バックエンドプロキシなしでユーザーが登録できるようにしたい。

#### 受け入れ基準

1. 登録APIは、レスポンスにCORSヘッダーを含まなければならない
2. 登録APIは、開発環境用に`http://localhost:3000`からのリクエストを許可しなければならない
3. 登録APIは、ステージング環境用に`https://stg.vote-board-game.example.com`からのリクエストを許可しなければならない
4. 登録APIは、本番環境用に`https://vote-board-game.example.com`からのリクエストを許可しなければならない
5. 登録APIは、POSTメソッドとContent-Typeヘッダーを許可しなければならない

### 要件12: リクエストログ

**ユーザーストーリー:** システム管理者として、登録試行がログに記録され、システム使用状況を監視し、問題を調査できるようにしたい。

#### 受け入れ基準

1. 登録リクエストを受信したとき、登録APIは、タイムスタンプ、メールアドレス（マスク済み）、IPアドレスを含むリクエストをログに記録しなければならない
2. 登録が成功したとき、登録APIは、userIdとタイムスタンプを含む成功イベントをログに記録しなければならない
3. 登録が失敗したとき、登録APIは、エラーコード、エラーメッセージ、タイムスタンプを含む失敗イベントをログに記録しなければならない
4. 登録APIは、すべてのログで機密データ（パスワード、トークン）をマスクしなければならない

### 要件13: 冪等性の処理

**ユーザーストーリー:** ネットワーク問題を経験しているユーザーとして、重複した登録リクエストが適切に処理され、誤って複数のアカウントを作成しないようにしたい。

#### 受け入れ基準

1. 既存のメールアドレスに対して登録リクエストを受信したとき、登録APIは、エラーコード`CONFLICT`を含む409ステータスコードを返さなければならない
2. 登録APIは、重複したCognitoユーザーまたはユーザーレコードを作成してはならない
3. エラーレスポンスは、セキュリティのためにアカウントの存在を明らかにすることなく、メールアドレスが既に登録されていることを示さなければならない

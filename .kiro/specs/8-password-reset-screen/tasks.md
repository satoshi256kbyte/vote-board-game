# Implementation Plan: パスワードリセット画面

## 概要

本実装計画は、投票ボードゲームアプリケーションのパスワードリセット画面機能を実装するためのタスクリストです。この機能は、パスワードを忘れたユーザーがメールアドレスを使用して確認コードを受け取り、新しいパスワードを設定できるフロントエンド画面を提供します。実装は既存のパスワードリセットAPI（spec 4）と統合し、Next.js 16、TypeScript、Tailwind CSS、shadcn/ui、Vitestを使用します。

## タスク

- [x] 1. プロジェクト構造とコアインターフェースのセットアップ
  - packages/web/src/app/password-reset/ディレクトリを作成
  - packages/web/src/components/auth/ディレクトリを確認（存在しない場合は作成）
  - packages/web/src/lib/hooks/ディレクトリを確認（存在しない場合は作成）
  - packages/web/src/lib/services/ディレクトリを確認（存在しない場合は作成）
  - TypeScript型定義を作成（PasswordResetRequest, PasswordResetResponse, PasswordResetConfirmRequest, PasswordResetConfirmResponse, FormErrors）
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8_

- [ ] 2. Auth Serviceの拡張
  - [x] 2.1 Auth ServiceにrequestPasswordResetメソッドを実装
    - packages/web/src/lib/services/auth-service.tsにrequestPasswordResetメソッドを追加
    - PasswordResetRequest型とPasswordResetResponse型を定義
    - POST /auth/password-resetエンドポイントへのAPI呼び出しを実装
    - HTTPステータスコード（429, 500）に基づくエラーハンドリング
    - ネットワークエラーの検出と適切なエラーメッセージの返却
    - _要件: 3.1, 5.1, 5.2, 5.3_

  - [x] 2.2 Auth ServiceにconfirmPasswordResetメソッドを実装
    - packages/web/src/lib/services/auth-service.tsにconfirmPasswordResetメソッドを追加
    - PasswordResetConfirmRequest型とPasswordResetConfirmResponse型を定義
    - POST /auth/password-reset/confirmエンドポイントへのAPI呼び出しを実装
    - HTTPステータスコード（400 INVALID_CODE, 400 VALIDATION_ERROR, 429, 500）に基づくエラーハンドリング
    - ネットワークエラーの検出と適切なエラーメッセージの返却
    - _要件: 8.1, 10.1, 10.2, 10.3, 10.4, 10.5_

  - [x] 2.3 Auth Serviceパスワードリセットメソッドのユニットテストを作成
    - packages/web/src/lib/services/auth-service.test.tsにテストを追加
    - requestPasswordResetメソッドの成功レスポンス（200）のテスト
    - requestPasswordResetメソッドのエラーレスポンス（429, 500）のテスト
    - requestPasswordResetメソッドのネットワークエラーのテスト
    - confirmPasswordResetメソッドの成功レスポンス（200）のテスト
    - confirmPasswordResetメソッドのエラーレスポンス（400, 429, 500）のテスト
    - confirmPasswordResetメソッドのネットワークエラーのテスト
    - _要件: 3.1, 5.1, 5.2, 5.3, 8.1, 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 3. usePasswordResetフックの実装
  - [x] 3.1 usePasswordResetカスタムフックを作成
    - packages/web/src/lib/hooks/use-password-reset.tsを作成
    - isLoading、error、successMessage状態の管理
    - requestCode関数の実装（Auth ServiceのrequestPasswordResetの呼び出し）
    - confirmReset関数の実装（Auth ServiceのconfirmPasswordResetの呼び出し）
    - resendCode関数の実装（Auth ServiceのrequestPasswordResetの再呼び出し）
    - エラーハンドリングとエラーメッセージの設定
    - 成功メッセージの設定
    - _要件: 3.1, 3.2, 3.3, 4.1, 4.2, 4.3, 5.1, 5.2, 5.3, 5.4, 8.1, 8.2, 8.3, 9.1, 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 11.2, 11.3_

  - [~] 3.2 usePasswordResetフックのユニットテストを作成
    - packages/web/src/lib/hooks/use-password-reset.test.tsxを作成
    - 確認コード送信成功フローのテスト
    - 確認コード送信失敗フローのテスト
    - パスワードリセット確認成功フローのテスト
    - パスワードリセット確認失敗フローのテスト
    - 確認コード再送信フローのテスト
    - ローディング状態の検証
    - エラー状態の検証
    - 成功メッセージの検証
    - _要件: 3.1, 3.2, 3.3, 4.1, 4.2, 4.3, 5.1, 5.2, 5.3, 5.4, 8.1, 8.2, 8.3, 9.1, 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 11.2, 11.3_

- [ ] 4. RequestCodeFormコンポーネントの実装
  - [~] 4.1 RequestCodeFormコンポーネントの基本構造を作成
    - packages/web/src/components/auth/request-code-form.tsxを作成
    - メールアドレス入力フィールドを実装
    - 確認コードを送信ボタンを実装
    - 説明テキストを実装
    - ログイン画面に戻るリンクを実装
    - shadcn/uiのInput、Button、Alertコンポーネントを使用
    - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [~] 4.2 クライアント側バリデーションを実装
    - メールアドレス形式のバリデーション関数（validateEmail）
    - onBlurイベントでのバリデーション実行
    - エラーメッセージの表示とフィールドのスタイリング
    - バリデーションエラー時の確認コードを送信ボタン無効化
    - _要件: 2.1, 2.2, 2.3_

  - [~] 4.3 確認コード送信フォーム送信処理を実装
    - handleSubmit関数の実装
    - フォーム全体のバリデーション
    - usePasswordResetフックのrequestCode関数の呼び出し
    - 確認コード送信成功時のonCodeSentコールバック呼び出し
    - APIエラーメッセージの表示
    - ローディング状態の管理（ボタンとフィールドの無効化、ローディングインジケーター）
    - _要件: 3.1, 3.2, 3.3, 3.4, 5.1, 5.2, 5.3, 5.4_

  - [~] 4.4 アクセシビリティ対応を実装
    - メールアドレス入力フィールドにaria-label属性を追加
    - エラーメッセージとフィールドをaria-describedby属性で関連付け
    - エラーメッセージにrole="alert"属性を追加
    - aria-invalid属性の動的設定
    - キーボードナビゲーションの確保
    - _要件: 14.1, 14.5_

  - [~] 4.5 RequestCodeFormコンポーネントのユニットテストを作成
    - packages/web/src/components/auth/request-code-form.test.tsxを作成
    - 初期表示のテスト（フォーム要素の存在確認）
    - バリデーションエラーの表示テスト
    - ローディング状態のUI変更テスト
    - 確認コード送信成功フローのテスト
    - 確認コード送信失敗フローのテスト
    - エラー後のUI状態復元テスト
    - ログイン画面へのリンクテスト
    - ARIA属性のテスト
    - _要件: 1.1-1.5, 2.1-2.3, 3.1-3.4, 5.1-5.4, 13.1, 14.1, 14.5_

- [~] 5. チェックポイント - RequestCodeFormのテストが通ることを確認
  - すべてのテストが通ることを確認し、質問があればユーザーに尋ねる

- [ ] 6. ConfirmResetFormコンポーネントの実装
  - [~] 6.1 ConfirmResetFormコンポーネントの基本構造を作成
    - packages/web/src/components/auth/confirm-reset-form.tsxを作成
    - 確認コード、新しいパスワード、新しいパスワード確認の入力フィールドを実装
    - パスワードをリセットボタンを実装
    - 確認コードを再送信リンクを実装
    - パスワード要件の説明テキストを実装
    - shadcn/uiのInput、Button、Alertコンポーネントを使用
    - _要件: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8, 11.1_

  - [~] 6.2 クライアント側バリデーションを実装
    - 確認コードのバリデーション関数（validateConfirmationCode）
    - 新しいパスワードのバリデーション関数（validateNewPassword）
    - パスワード確認のバリデーション関数（validatePasswordConfirmation）
    - onBlurイベントでのバリデーション実行
    - エラーメッセージの表示とフィールドのスタイリング
    - バリデーションエラー時のパスワードをリセットボタン無効化
    - 確認コード入力フィールドの数字のみ入力制限
    - _要件: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9_

  - [~] 6.3 パスワード表示切り替え機能を実装
    - 新しいパスワードフィールドとパスワード確認フィールドの表示切り替えボタン
    - showNewPassword、showPasswordConfirmation状態の管理
    - Eye/EyeOffアイコン（lucide-react）の使用
    - type属性の動的切り替え（password/text）
    - _要件: 12.1, 12.2, 12.3, 12.4, 12.5_

  - [~] 6.4 パスワードリセット確認フォーム送信処理を実装
    - handleSubmit関数の実装
    - フォーム全体のバリデーション
    - usePasswordResetフックのconfirmReset関数の呼び出し
    - パスワードリセット成功時の成功メッセージ表示と3秒後の/loginへのリダイレクト
    - APIエラーメッセージの表示
    - ローディング状態の管理（ボタンとフィールドの無効化、ローディングインジケーター）
    - _要件: 8.1, 8.2, 8.3, 8.4, 9.1, 9.2, 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_

  - [~] 6.5 確認コード再送信機能を実装
    - handleResendCode関数の実装
    - usePasswordResetフックのresendCode関数の呼び出し
    - 再送信中の確認コードを再送信リンクの無効化
    - 再送信成功メッセージの表示
    - _要件: 11.1, 11.2, 11.3, 11.4_

  - [~] 6.6 アクセシビリティ対応を実装
    - すべての入力フィールドにaria-label属性を追加
    - エラーメッセージとフィールドをaria-describedby属性で関連付け
    - エラーメッセージにrole="alert"属性を追加
    - aria-invalid属性の動的設定
    - ボタン無効化時のaria-disabled属性の設定
    - パスワード表示切り替えボタンにaria-label属性を追加
    - キーボードナビゲーションの確保
    - _要件: 14.2, 14.3, 14.4, 14.5, 14.6, 14.7_

  - [~] 6.7 レスポンシブデザインを実装
    - モバイル、タブレット、デスクトップでの最適なレイアウト
    - Tailwind CSSのレスポンシブクラスを使用
    - タッチ可能要素の最小サイズ（44x44px）を確保
    - 単一カラムレイアウト
    - _要件: 15.1, 15.2, 15.3, 15.4_

  - [~] 6.8 ConfirmResetFormコンポーネントのユニットテストを作成
    - packages/web/src/components/auth/confirm-reset-form.test.tsxを作成
    - 初期表示のテスト（フォーム要素の存在確認）
    - バリデーションエラーの表示テスト
    - ローディング状態のUI変更テスト
    - パスワード表示切り替えのテスト
    - 確認コード再送信のテスト
    - パスワードリセット成功フローのテスト
    - パスワードリセット失敗フローのテスト
    - エラー後のUI状態復元テスト
    - ARIA属性のテスト
    - レスポンシブレイアウトのテスト
    - _要件: 6.1-6.8, 7.1-7.9, 8.1-8.4, 9.1-9.2, 10.1-10.6, 11.1-11.4, 12.1-12.5, 14.2-14.7, 15.1-15.4_

- [~] 7. チェックポイント - ConfirmResetFormのテストが通ることを確認
  - すべてのテストが通ることを確認し、質問があればユーザーに尋ねる

- [ ] 8. PasswordResetPageコンポーネントの実装
  - [~] 8.1 PasswordResetPageコンポーネントを作成
    - packages/web/src/app/password-reset/page.tsxを作成
    - ステップ管理（step: 'request' | 'confirm'）
    - メールアドレスの保持
    - RequestCodeFormまたはConfirmResetFormのレンダリング
    - ページタイトルと説明の表示
    - ページ離脱時のフォームデータクリア（useEffectのクリーンアップ関数）
    - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 4.1, 4.2, 4.3, 4.4, 6.1, 6.2, 6.3, 6.4, 16.5_

  - [~] 8.2 PasswordResetPageコンポーネントのユニットテストを作成
    - packages/web/src/app/password-reset/page.test.tsxを作成
    - ステップ遷移（request → confirm）のテスト
    - メールアドレスの保持のテスト
    - ページ離脱時のデータクリアのテスト
    - _要件: 4.1, 4.2, 4.3, 4.4, 16.5_

- [ ] 9. プロパティベーステストの実装
  - [~] 9.1 プロパティ1のテストを作成: メールアドレスバリデーション
    - packages/web/src/components/auth/request-code-form.property.test.tsxを作成
    - fast-checkを使用してランダムなメールアドレス入力を生成
    - 空または無効なメール形式に対するエラーメッセージの表示を検証
    - **プロパティ1: メールアドレスバリデーション**
    - **検証: 要件 2.1, 2.2**

  - [~] 9.2 プロパティ2のテストを作成: バリデーションエラー時のAPI呼び出し防止（確認コード送信）
    - バリデーションエラーが存在する場合のAPI呼び出し防止を検証
    - **プロパティ2: バリデーションエラー時のAPI呼び出し防止（確認コード送信）**
    - **検証: 要件 2.3**

  - [~] 9.3 プロパティ3のテストを作成: 有効なメールアドレスでのAPI呼び出し
    - 有効なメールアドレスでのパスワードリセット要求API呼び出しを検証
    - **プロパティ3: 有効なメールアドレスでのAPI呼び出し**
    - **検証: 要件 3.1**

  - [~] 9.4 プロパティ4のテストを作成: メールアドレスの保持
    - 確認コード送信成功時のメールアドレス保持を検証
    - **プロパティ4: メールアドレスの保持**
    - **検証: 要件 4.4**

  - [~] 9.5 プロパティ5のテストを作成: 確認コード送信失敗時のエラーメッセージ表示
    - 各種APIエラー（429, 500、ネットワークエラー）に対するエラーメッセージの表示を検証
    - **プロパティ5: 確認コード送信失敗時のエラーメッセージ表示**
    - **検証: 要件 5.1, 5.2, 5.3**

  - [~] 9.6 プロパティ6のテストを作成: エラー後のUI状態復元（確認コード送信）
    - エラー後のボタンとフィールドの再有効化を検証
    - **プロパティ6: エラー後のUI状態復元（確認コード送信）**
    - **検証: 要件 5.4**

  - [~] 9.7 プロパティ7のテストを作成: 確認コードバリデーション
    - packages/web/src/components/auth/confirm-reset-form.property.test.tsxを作成
    - 空または6桁の数字でない確認コードに対するエラーメッセージの表示を検証
    - **プロパティ7: 確認コードバリデーション**
    - **検証: 要件 7.1, 7.2**

  - [~] 9.8 プロパティ8のテストを作成: パスワード要件バリデーション
    - 各種パスワード要件違反に対するエラーメッセージの表示を検証
    - **プロパティ8: パスワード要件バリデーション**
    - **検証: 要件 7.3, 7.4, 7.5, 7.6, 7.7**

  - [~] 9.9 プロパティ9のテストを作成: パスワード確認の一致検証
    - 一致しないパスワードとパスワード確認に対するエラーメッセージの表示を検証
    - **プロパティ9: パスワード確認の一致検証**
    - **検証: 要件 7.8**

  - [~] 9.10 プロパティ10のテストを作成: バリデーションエラー時のAPI呼び出し防止（パスワードリセット確認）
    - バリデーションエラーが存在する場合のAPI呼び出し防止を検証
    - **プロパティ10: バリデーションエラー時のAPI呼び出し防止（パスワードリセット確認）**
    - **検証: 要件 7.9**

  - [~] 9.11 プロパティ11のテストを作成: 有効な入力でのAPI呼び出し（パスワードリセット確認）
    - 有効な確認コード、新しいパスワード、パスワード確認でのAPI呼び出しを検証
    - **プロパティ11: 有効な入力でのAPI呼び出し（パスワードリセット確認）**
    - **検証: 要件 8.1**

  - [~] 9.12 プロパティ12のテストを作成: パスワードリセット確認失敗時のエラーメッセージ表示
    - 各種APIエラー（400 INVALID_CODE, 400 VALIDATION_ERROR, 429, 500、ネットワークエラー）に対するエラーメッセージの表示を検証
    - **プロパティ12: パスワードリセット確認失敗時のエラーメッセージ表示**
    - **検証: 要件 10.1, 10.2, 10.3, 10.4, 10.5**

  - [~] 9.13 プロパティ13のテストを作成: エラー後のUI状態復元（パスワードリセット確認）
    - エラー後のボタンとフィールドの再有効化を検証
    - **プロパティ13: エラー後のUI状態復元（パスワードリセット確認）**
    - **検証: 要件 10.6**

  - [~] 9.14 プロパティ14のテストを作成: 確認コード再送信のAPI呼び出し
    - 確認コード再送信リンククリック時のAPI呼び出しを検証
    - **プロパティ14: 確認コード再送信のAPI呼び出し**
    - **検証: 要件 11.2**

  - [~] 9.15 プロパティ15のテストを作成: パスワード表示切り替えのラウンドトリップ
    - パスワード表示切り替えボタンを2回クリックした際の元の状態への復帰を検証
    - **プロパティ15: パスワード表示切り替えのラウンドトリップ**
    - **検証: 要件 12.3, 12.4**

  - [~] 9.16 プロパティ16のテストを作成: ログイン画面へのナビゲーション
    - ログイン画面に戻るリンククリック時の/loginへの遷移を検証
    - **プロパティ16: ログイン画面へのナビゲーション**
    - **検証: 要件 13.1**

  - [~] 9.17 プロパティ17のテストを作成: バリデーションエラーのrole="alert"属性
    - エラーメッセージのrole="alert"属性を検証
    - **プロパティ17: バリデーションエラーのrole="alert"属性**
    - **検証: 要件 14.5**

  - [~] 9.18 プロパティ18のテストを作成: 無効化ボタンのaria-disabled属性
    - ボタン無効化時のaria-disabled="true"属性を検証
    - **プロパティ18: 無効化ボタンのaria-disabled属性**
    - **検証: 要件 14.6**

  - [~] 9.19 プロパティ19のテストを作成: タッチ可能要素の最小サイズ
    - インタラクティブ要素の最小タップ領域（44x44px）を検証
    - **プロパティ19: タッチ可能要素の最小サイズ**
    - **検証: 要件 15.4**

  - [~] 9.20 プロパティ20のテストを作成: 機密データのログ保護
    - パスワード、パスワード確認、確認コードがコンソールログに出力されないことを検証
    - **プロパティ20: 機密データのログ保護**
    - **検証: 要件 16.1, 16.2**

- [~] 10. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、質問があればユーザーに尋ねる

## 注意事項

- `*`マークが付いたタスクはオプションであり、MVPでは省略可能です
- 各タスクは前のタスクに基づいて構築されます
- プロパティベーステストは設計ドキュメントのプロパティを参照します
- チェックポイントで段階的な検証を行います
- すべてのコードはTypeScriptで記述します
- Next.js 16のApp Routerを使用します
- shadcn/uiコンポーネントを活用します
- Vitestでテストを実行します
- パスワード、パスワード確認、確認コードはローカルストレージに保存しません
- ページ離脱時にフォームデータをクリアします

# 要件定義書

## はじめに

本ドキュメントは、投票ボードゲームアプリケーションのパスワードリセット画面機能の要件を定義します。パスワードリセット画面は、パスワードを忘れたユーザーがメールアドレスを使用して確認コードを受け取り、新しいパスワードを設定できるようにするフロントエンド機能です。この画面は、既存のパスワードリセットAPI（spec 4）と統合し、2段階のフロー（確認コード送信→パスワードリセット確認）を提供します。

## 用語集

- **パスワードリセット画面**: ユーザーがパスワードをリセットするためのUIコンポーネント
- **確認コード送信フォーム**: メールアドレスを入力して確認コードを送信するフォーム
- **パスワードリセット確認フォーム**: 確認コード、新しいパスワード、パスワード確認を入力してパスワードをリセットするフォーム
- **パスワードリセット要求API**: 確認コードをメールで送信するバックエンドエンドポイント（`/auth/password-reset`）
- **パスワードリセット確認API**: 確認コードと新しいパスワードでパスワードをリセットするバックエンドエンドポイント（`/auth/password-reset/confirm`）
- **確認コード**: Cognitoがユーザーのメールアドレスに送信する6桁の数字コード
- **フォームバリデーション**: ユーザー入力の妥当性をクライアント側で検証する処理
- **エラーメッセージ**: バリデーションエラーまたはAPI呼び出しエラーをユーザーに表示するテキスト
- **ログイン画面**: ユーザーがログインするための画面

## 要件

### 要件1: 確認コード送信フォームの表示

**ユーザーストーリー:** パスワードを忘れたユーザーとして、メールアドレスを入力して確認コードを受け取り、パスワードをリセットしたい。

#### 受け入れ基準

1. パスワードリセット画面は、メールアドレス入力フィールドを表示しなければならない
2. パスワードリセット画面は、「確認コードを送信」ボタンを表示しなければならない
3. パスワードリセット画面は、説明テキスト「登録されているメールアドレスを入力してください。パスワードリセット用の確認コードを送信します。」を表示しなければならない
4. メールアドレス入力フィールドは、プレースホルダーテキスト「メールアドレス」を表示しなければならない
5. パスワードリセット画面は、「ログイン画面に戻る」リンクを表示しなければならない

### 要件2: 確認コード送信のクライアント側バリデーション

**ユーザーストーリー:** ユーザーとして、フォーム送信前に入力エラーを即座に確認し、正しい形式で入力できるようにしたい。

#### 受け入れ基準

1. メールアドレスフィールドが空の状態で「確認コードを送信」ボタンをクリックしたとき、パスワードリセット画面は、エラーメッセージ「メールアドレスを入力してください」を表示しなければならない
2. メールアドレスフィールドに無効な形式のメールアドレスが入力された状態で「確認コードを送信」ボタンをクリックしたとき、パスワードリセット画面は、エラーメッセージ「有効なメールアドレスを入力してください」を表示しなければならない
3. バリデーションエラーが存在する場合、パスワードリセット画面は、パスワードリセット要求APIを呼び出してはならない

### 要件3: 確認コード送信API呼び出し

**ユーザーストーリー:** ユーザーとして、有効なメールアドレスを入力して確認コードを送信し、パスワードリセットプロセスを開始したい。

#### 受け入れ基準

1. すべてのバリデーションが通過した状態で「確認コードを送信」ボタンをクリックしたとき、パスワードリセット画面は、入力されたメールアドレスを含むPOSTリクエストをパスワードリセット要求APIに送信しなければならない
2. パスワードリセット要求APIリクエストを送信している間、パスワードリセット画面は、「確認コードを送信」ボタンを無効化しなければならない
3. パスワードリセット要求APIリクエストを送信している間、パスワードリセット画面は、ローディングインジケーター（スピナーまたは「送信中...」テキスト）を表示しなければならない
4. パスワードリセット要求APIリクエストを送信している間、パスワードリセット画面は、メールアドレス入力フィールドを無効化しなければならない

### 要件4: 確認コード送信成功時の処理

**ユーザーストーリー:** ユーザーとして、確認コード送信に成功したら、確認コードを入力してパスワードをリセットしたい。

#### 受け入れ基準

1. パスワードリセット要求APIが200ステータスコードを返したとき、パスワードリセット画面は、確認コード送信フォームを非表示にしなければならない
2. パスワードリセット画面は、パスワードリセット確認フォームを表示しなければならない
3. パスワードリセット画面は、成功メッセージ「確認コードをメールで送信しました。メールをご確認ください。」を表示しなければならない
4. パスワードリセット画面は、入力されたメールアドレスを保持し、パスワードリセット確認API呼び出し時に使用しなければならない

### 要件5: 確認コード送信失敗時のエラー表示

**ユーザーストーリー:** ユーザーとして、確認コード送信に失敗した場合、その理由を明確に理解し、適切に対処したい。

#### 受け入れ基準

1. パスワードリセット要求APIが429ステータスコードを返したとき、パスワードリセット画面は、エラーメッセージ「リクエスト回数が上限に達しました。しばらくしてから再度お試しください」を表示しなければならない
2. パスワードリセット要求APIが500ステータスコードを返したとき、パスワードリセット画面は、エラーメッセージ「サーバーエラーが発生しました。しばらくしてから再度お試しください」を表示しなければならない
3. ネットワークエラーが発生したとき、パスワードリセット画面は、エラーメッセージ「ネットワークエラーが発生しました。インターネット接続を確認してください」を表示しなければならない
4. エラーメッセージを表示したとき、パスワードリセット画面は、「確認コードを送信」ボタンとメールアドレス入力フィールドを再度有効化しなければならない

### 要件6: パスワードリセット確認フォームの表示

**ユーザーストーリー:** 確認コードを受け取ったユーザーとして、確認コードと新しいパスワードを入力してパスワードをリセットしたい。

#### 受け入れ基準

1. パスワードリセット確認フォームは、確認コード入力フィールドを表示しなければならない
2. パスワードリセット確認フォームは、新しいパスワード入力フィールドを表示しなければならない
3. パスワードリセット確認フォームは、新しいパスワード確認入力フィールドを表示しなければならない
4. パスワードリセット確認フォームは、「パスワードをリセット」ボタンを表示しなければならない
5. 確認コード入力フィールドは、プレースホルダーテキスト「6桁の確認コード」を表示しなければならない
6. 新しいパスワード入力フィールドは、プレースホルダーテキスト「新しいパスワード」を表示しなければならない
7. 新しいパスワード確認入力フィールドは、プレースホルダーテキスト「新しいパスワード（確認）」を表示しなければならない
8. パスワードリセット確認フォームは、パスワード要件の説明テキスト「8文字以上、大文字・小文字・数字を含む」を表示しなければならない

### 要件7: パスワードリセット確認のクライアント側バリデーション

**ユーザーストーリー:** ユーザーとして、フォーム送信前に入力エラーを即座に確認し、正しい形式で入力できるようにしたい。

#### 受け入れ基準

1. 確認コードフィールドが空の状態で「パスワードをリセット」ボタンをクリックしたとき、パスワードリセット画面は、エラーメッセージ「確認コードを入力してください」を表示しなければならない
2. 確認コードフィールドに6桁の数字以外が入力された状態で「パスワードをリセット」ボタンをクリックしたとき、パスワードリセット画面は、エラーメッセージ「確認コードは6桁の数字である必要があります」を表示しなければならない
3. 新しいパスワードフィールドが空の状態で「パスワードをリセット」ボタンをクリックしたとき、パスワードリセット画面は、エラーメッセージ「新しいパスワードを入力してください」を表示しなければならない
4. 新しいパスワードが8文字未満の場合、パスワードリセット画面は、エラーメッセージ「パスワードは8文字以上である必要があります」を表示しなければならない
5. 新しいパスワードに大文字が含まれていない場合、パスワードリセット画面は、エラーメッセージ「パスワードには大文字を含める必要があります」を表示しなければならない
6. 新しいパスワードに小文字が含まれていない場合、パスワードリセット画面は、エラーメッセージ「パスワードには小文字を含める必要があります」を表示しなければならない
7. 新しいパスワードに数字が含まれていない場合、パスワードリセット画面は、エラーメッセージ「パスワードには数字を含める必要があります」を表示しなければならない
8. 新しいパスワード確認フィールドが新しいパスワードフィールドと一致しない場合、パスワードリセット画面は、エラーメッセージ「パスワードが一致しません」を表示しなければならない
9. バリデーションエラーが存在する場合、パスワードリセット画面は、パスワードリセット確認APIを呼び出してはならない

### 要件8: パスワードリセット確認API呼び出し

**ユーザーストーリー:** ユーザーとして、有効な確認コードと新しいパスワードを入力してパスワードリセットを完了したい。

#### 受け入れ基準

1. すべてのバリデーションが通過した状態で「パスワードをリセット」ボタンをクリックしたとき、パスワードリセット画面は、メールアドレス、確認コード、新しいパスワードを含むPOSTリクエストをパスワードリセット確認APIに送信しなければならない
2. パスワードリセット確認APIリクエストを送信している間、パスワードリセット画面は、「パスワードをリセット」ボタンを無効化しなければならない
3. パスワードリセット確認APIリクエストを送信している間、パスワードリセット画面は、ローディングインジケーター（スピナーまたは「リセット中...」テキスト）を表示しなければならない
4. パスワードリセット確認APIリクエストを送信している間、パスワードリセット画面は、すべての入力フィールドを無効化しなければならない

### 要件9: パスワードリセット成功時の処理

**ユーザーストーリー:** ユーザーとして、パスワードリセットに成功したら、新しいパスワードでログインしたい。

#### 受け入れ基準

1. パスワードリセット確認APIが200ステータスコードを返したとき、パスワードリセット画面は、成功メッセージ「パスワードがリセットされました。新しいパスワードでログインしてください。」を表示しなければならない
2. 成功メッセージを3秒間表示した後、パスワードリセット画面は、ユーザーをログイン画面（`/login`）にリダイレクトしなければならない

### 要件10: パスワードリセット確認失敗時のエラー表示

**ユーザーストーリー:** ユーザーとして、パスワードリセット確認に失敗した場合、その理由を明確に理解し、適切に対処したい。

#### 受け入れ基準

1. パスワードリセット確認APIが400ステータスコードとエラーコード`INVALID_CODE`を返したとき、パスワードリセット画面は、エラーメッセージ「確認コードが無効または期限切れです」を表示しなければならない
2. パスワードリセット確認APIが400ステータスコードとエラーコード`VALIDATION_ERROR`を返したとき、パスワードリセット画面は、APIから返されたバリデーションエラーメッセージを表示しなければならない
3. パスワードリセット確認APIが429ステータスコードを返したとき、パスワードリセット画面は、エラーメッセージ「リクエスト回数が上限に達しました。しばらくしてから再度お試しください」を表示しなければならない
4. パスワードリセット確認APIが500ステータスコードを返したとき、パスワードリセット画面は、エラーメッセージ「サーバーエラーが発生しました。しばらくしてから再度お試しください」を表示しなければならない
5. ネットワークエラーが発生したとき、パスワードリセット画面は、エラーメッセージ「ネットワークエラーが発生しました。インターネット接続を確認してください」を表示しなければならない
6. エラーメッセージを表示したとき、パスワードリセット画面は、「パスワードをリセット」ボタンとすべての入力フィールドを再度有効化しなければならない

### 要件11: 確認コード再送信機能

**ユーザーストーリー:** ユーザーとして、確認コードが届かない場合や期限切れの場合、確認コードを再送信したい。

#### 受け入れ基準

1. パスワードリセット確認フォームは、「確認コードを再送信」リンクを表示しなければならない
2. 「確認コードを再送信」リンクをクリックしたとき、パスワードリセット画面は、保持しているメールアドレスを使用してパスワードリセット要求APIを再度呼び出さなければならない
3. 確認コード再送信が成功したとき、パスワードリセット画面は、成功メッセージ「確認コードを再送信しました」を表示しなければならない
4. 確認コード再送信リクエストを送信している間、パスワードリセット画面は、「確認コードを再送信」リンクを無効化しなければならない

### 要件12: パスワード表示切り替え

**ユーザーストーリー:** ユーザーとして、入力したパスワードを確認するために、パスワードの表示/非表示を切り替えたい。

#### 受け入れ基準

1. 新しいパスワード入力フィールドの右側に、パスワード表示切り替えボタン（目のアイコン）を表示しなければならない
2. 新しいパスワード確認入力フィールドの右側に、パスワード表示切り替えボタン（目のアイコン）を表示しなければならない
3. パスワード表示切り替えボタンをクリックしたとき、パスワードリセット画面は、対応するパスワードフィールドを平文で表示しなければならない
4. パスワードが平文表示されている状態でパスワード表示切り替えボタンをクリックしたとき、パスワードリセット画面は、パスワードをマスク表示に戻さなければならない
5. パスワード表示切り替えボタンは、現在の表示状態を示すアイコン（表示中は「目を閉じた」アイコン、非表示中は「目を開いた」アイコン）を表示しなければならない

### 要件13: ログイン画面へのナビゲーション

**ユーザーストーリー:** ユーザーとして、パスワードを思い出した場合やパスワードリセットをキャンセルしたい場合、ログイン画面に簡単に戻りたい。

#### 受け入れ基準

1. 「ログイン画面に戻る」リンクをクリックしたとき、パスワードリセット画面は、ユーザーをログイン画面（`/login`）に遷移させなければならない

### 要件14: アクセシビリティ対応

**ユーザーストーリー:** スクリーンリーダーを使用するユーザーとして、パスワードリセットフォームを適切に操作し、エラーメッセージを理解したい。

#### 受け入れ基準

1. メールアドレス入力フィールドは、`aria-label`属性「メールアドレス」を持たなければならない
2. 確認コード入力フィールドは、`aria-label`属性「確認コード」を持たなければならない
3. 新しいパスワード入力フィールドは、`aria-label`属性「新しいパスワード」を持たなければならない
4. 新しいパスワード確認入力フィールドは、`aria-label`属性「新しいパスワード確認」を持たなければならない
5. バリデーションエラーが表示されたとき、パスワードリセット画面は、エラーメッセージに`role="alert"`属性を設定しなければならない
6. ボタンが無効化されている間、パスワードリセット画面は、`aria-disabled="true"`属性を設定しなければならない
7. パスワード表示切り替えボタンは、`aria-label`属性「パスワードを表示」または「パスワードを非表示」を持たなければならない

### 要件15: レスポンシブデザイン

**ユーザーストーリー:** モバイルデバイスユーザーとして、スマートフォンやタブレットでもパスワードリセット画面を快適に使用したい。

#### 受け入れ基準

1. パスワードリセット画面は、画面幅320px以上のすべてのデバイスで適切に表示されなければならない
2. モバイルデバイス（画面幅768px未満）では、パスワードリセット画面は、フォーム要素を縦方向に配置しなければならない
3. タブレットおよびデスクトップデバイス（画面幅768px以上）では、パスワードリセット画面は、フォームを中央に配置し、最大幅400pxに制限しなければならない
4. すべてのタッチ可能な要素（ボタン、リンク）は、最小タップ領域44x44pxを確保しなければならない

### 要件16: セキュリティ対策

**ユーザーストーリー:** セキュリティを重視するユーザーとして、パスワードリセット処理が安全に行われ、認証情報が保護されることを望む。

#### 受け入れ基準

1. パスワードリセット画面は、パスワードをブラウザのコンソールログに出力してはならない
2. パスワードリセット画面は、確認コードをブラウザのコンソールログに出力してはならない
3. パスワードリセット画面は、パスワードをURLパラメータに含めてはならない
4. パスワードリセット画面は、パスワードリセットAPIへのリクエストをHTTPS経由で送信しなければならない
5. パスワードリセット画面は、ページを離れる際にフォームデータをクリアしなければならない

# 要件定義書

## はじめに

本ドキュメントは、投票ボードゲームアプリケーションのパスワードリセットAPI機能の要件を定義します。パスワードリセットAPIは、パスワードを忘れたユーザーがメールアドレスを使用してパスワードをリセットできるようにします。このAPIは、Amazon Cognitoの`ForgotPassword`および`ConfirmForgotPassword`フローを使用して、安全なパスワードリセットプロセスを提供します。

## 用語集

- **パスワードリセット要求API**: パスワードリセット用の確認コードをメールで送信するHTTP APIエンドポイント
- **パスワードリセット確認API**: 確認コードと新しいパスワードでパスワードをリセットするHTTP APIエンドポイント
- **Cognitoサービス**: ユーザー認証とIDを管理するAmazon Cognitoサービス
- **確認コード**: Cognitoがユーザーのメールアドレスに送信する6桁の数字コード
- **メールアドレス**: ユーザーの一意の識別子として使用される有効なメールアドレス
- **パスワード**: セキュリティ要件を満たす秘密の認証情報（8文字以上、大文字・小文字・数字を含む）
- **レート制限**: 不正アクセスを防ぐためのリクエスト頻度制限

## 要件

### 要件1: パスワードリセット要求エンドポイント

**ユーザーストーリー:** パスワードを忘れたユーザーとして、メールアドレスを入力してパスワードリセット用の確認コードを受け取り、パスワードを再設定したい。

#### 受け入れ基準

1. パスワードリセット要求APIは、`/auth/password-reset`エンドポイントでPOSTリクエストを受け付けなければならない
2. パスワードリセット要求リクエストを受信したとき、パスワードリセット要求APIは、リクエストボディにemailフィールドが含まれていることを検証しなければならない
3. emailフィールドが欠落または空の場合、パスワードリセット要求APIは、エラーコード`VALIDATION_ERROR`を含む400ステータスコードを返さなければならない
4. emailフィールドが標準のメール形式（RFC 5322）に一致しない場合、パスワードリセット要求APIは、エラーコード`VALIDATION_ERROR`とメッセージ「Invalid email format」を含む400ステータスコードを返さなければならない

### 要件2: Cognitoパスワードリセット要求の実行

**ユーザーストーリー:** パスワードを忘れたユーザーとして、確認コードをメールで受け取り、安全にパスワードをリセットしたい。

#### 受け入れ基準

1. すべての検証が通過したとき、パスワードリセット要求APIは、CognitoサービスのForgotPasswordフローを使用して確認コードの送信を開始しなければならない
2. Cognitoサービスが確認コードの送信を完了したとき、パスワードリセット要求APIは、200ステータスコードとメッセージ「Password reset code has been sent」を含むレスポンスを返さなければならない
3. 指定されたメールアドレスがCognitoに存在しない場合、パスワードリセット要求APIは、アカウントの存在を明らかにせず、200ステータスコードと同一のメッセージを返さなければならない
4. Cognitoサービスが予期しないエラーを返した場合、パスワードリセット要求APIは、エラーコード`INTERNAL_ERROR`を含む500ステータスコードを返さなければならない

### 要件3: パスワードリセット確認エンドポイント

**ユーザーストーリー:** 確認コードを受け取ったユーザーとして、確認コードと新しいパスワードを入力してパスワードをリセットし、アカウントに再びアクセスしたい。

#### 受け入れ基準

1. パスワードリセット確認APIは、`/auth/password-reset/confirm`エンドポイントでPOSTリクエストを受け付けなければならない
2. パスワードリセット確認リクエストを受信したとき、パスワードリセット確認APIは、リクエストボディにemail、confirmationCode、newPasswordフィールドが含まれていることを検証しなければならない
3. emailフィールドが欠落、空、または無効な形式の場合、パスワードリセット確認APIは、エラーコード`VALIDATION_ERROR`を含む400ステータスコードを返さなければならない
4. confirmationCodeフィールドが欠落または空の場合、パスワードリセット確認APIは、エラーコード`VALIDATION_ERROR`を含む400ステータスコードを返さなければならない
5. newPasswordフィールドが欠落または空の場合、パスワードリセット確認APIは、エラーコード`VALIDATION_ERROR`を含む400ステータスコードを返さなければならない

### 要件4: 確認コードの検証

**ユーザーストーリー:** ユーザーとして、正しい確認コードを入力したときにパスワードがリセットされ、不正な確認コードでは拒否されることを望む。

#### 受け入れ基準

1. パスワードリセット確認APIは、confirmationCodeが6桁の数字であることを検証しなければならない
2. confirmationCodeが6桁の数字でない場合、パスワードリセット確認APIは、エラーコード`VALIDATION_ERROR`とメッセージ「Confirmation code must be 6 digits」を含む400ステータスコードを返さなければならない
3. 確認コードが無効または期限切れの場合、パスワードリセット確認APIは、エラーコード`INVALID_CODE`とメッセージ「Invalid or expired confirmation code」を含む400ステータスコードを返さなければならない

### 要件5: 新しいパスワードの検証

**ユーザーストーリー:** セキュリティを重視するユーザーとして、新しいパスワードがセキュリティ基準を満たすことを望み、リセット後もアカウントが保護されるようにしたい。

#### 受け入れ基準

1. パスワードリセット確認APIは、新しいパスワードが少なくとも8文字の長さであることを検証しなければならない
2. パスワードリセット確認APIは、新しいパスワードに少なくとも1つの大文字が含まれていることを検証しなければならない
3. パスワードリセット確認APIは、新しいパスワードに少なくとも1つの小文字が含まれていることを検証しなければならない
4. パスワードリセット確認APIは、新しいパスワードに少なくとも1つの数字が含まれていることを検証しなければならない
5. パスワード要件が満たされていない場合、パスワードリセット確認APIは、エラーコード`VALIDATION_ERROR`と、どの要件が満たされていないかを示す説明メッセージを含む400ステータスコードを返さなければならない

### 要件6: Cognitoパスワードリセット確認の実行

**ユーザーストーリー:** ユーザーとして、確認コードと新しいパスワードを送信してパスワードリセットを完了し、新しいパスワードでログインしたい。

#### 受け入れ基準

1. すべての検証が通過したとき、パスワードリセット確認APIは、CognitoサービスのConfirmForgotPasswordフローを使用してパスワードをリセットしなければならない
2. パスワードリセットが成功したとき、パスワードリセット確認APIは、200ステータスコードとメッセージ「Password has been reset successfully」を含むレスポンスを返さなければならない
3. Cognitoサービスが予期しないエラーを返した場合、パスワードリセット確認APIは、エラーコード`INTERNAL_ERROR`を含む500ステータスコードを返さなければならない

### 要件7: レート制限

**ユーザーストーリー:** システム管理者として、パスワードリセットエンドポイントへのブルートフォース攻撃を防ぎ、正当なユーザーがシステムを利用できるようにしたい。

#### 受け入れ基準

1. パスワードリセット要求APIは、IPアドレスごとに1分あたり3リクエストのレート制限を適用しなければならない
2. パスワードリセット確認APIは、IPアドレスごとに1分あたり5リクエストのレート制限を適用しなければならない
3. レート制限を超えたとき、パスワードリセットAPIは、エラーコード`RATE_LIMIT_EXCEEDED`を含む429ステータスコードを返さなければならない
4. レスポンスは、次のリクエストが許可されるまでの秒数を示す`retryAfter`フィールドを含まなければならない

### 要件8: セキュリティ対策

**ユーザーストーリー:** セキュリティを重視するユーザーとして、パスワードリセット処理が安全に行われ、アカウント情報が保護されることを望む。

#### 受け入れ基準

1. パスワードリセット要求APIは、メールアドレスの存在有無を明らかにしてはならない（登録済み・未登録に関わらず同一のレスポンスを返す）
2. パスワードリセットAPIは、パスワードをログに出力してはならない
3. パスワードリセットAPIは、確認コードをログに出力してはならない
4. パスワードリセットAPIは、メールアドレスをマスクしてログに記録しなければならない

### 要件9: エラーレスポンス形式

**ユーザーストーリー:** クライアントアプリケーション開発者として、一貫したエラーレスポンスを受け取り、エラーを予測可能に処理し、ユーザーに明確なフィードバックを提供したい。

#### 受け入れ基準

1. エラーが発生したとき、パスワードリセットAPIは、error、message、オプションのdetailsフィールドを含むJSONレスポンスを返さなければならない
2. errorフィールドは、機械可読なエラーコードを含まなければならない
3. messageフィールドは、人間が読めるエラー説明を含まなければならない
4. 検証エラーが発生した場合、detailsフィールドは、フィールド名をエラーメッセージにマッピングするfieldsオブジェクトを含まなければならない

### 要件10: リクエストログ

**ユーザーストーリー:** システム管理者として、パスワードリセット試行がログに記録され、不正アクセスの監視と問題の調査ができるようにしたい。

#### 受け入れ基準

1. パスワードリセット要求リクエストを受信したとき、パスワードリセットAPIは、タイムスタンプ、メールアドレス（マスク済み）、IPアドレスを含むリクエストをログに記録しなければならない
2. パスワードリセット要求が成功したとき、パスワードリセットAPIは、タイムスタンプを含む成功イベントをログに記録しなければならない
3. パスワードリセット確認が成功したとき、パスワードリセットAPIは、メールアドレス（マスク済み）とタイムスタンプを含む成功イベントをログに記録しなければならない
4. パスワードリセットが失敗したとき、パスワードリセットAPIは、エラーコード、タイムスタンプを含む失敗イベントをログに記録しなければならない

### 要件11: CORS設定

**ユーザーストーリー:** Webアプリケーションとして、ブラウザからパスワードリセットAPIを呼び出し、バックエンドプロキシなしでユーザーがパスワードをリセットできるようにしたい。

#### 受け入れ基準

1. パスワードリセットAPIは、レスポンスにCORSヘッダーを含まなければならない
2. パスワードリセットAPIは、開発環境用に`http://localhost:3000`からのリクエストを許可しなければならない
3. パスワードリセットAPIは、ステージング環境用に`https://stg.vote-board-game.example.com`からのリクエストを許可しなければならない
4. パスワードリセットAPIは、本番環境用に`https://vote-board-game.example.com`からのリクエストを許可しなければならない
5. パスワードリセットAPIは、POSTメソッドとContent-Typeヘッダーを許可しなければならない

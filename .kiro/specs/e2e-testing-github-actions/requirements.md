# 要件定義書

## はじめに

このドキュメントは、GitHub ActionsでE2Eテストを実行する機能の要件を定義します。
目的は品質チェックではなく、基本的な疎通確認（スモークテスト）です。
MVPとして最小限のテストケースを実装し、Development環境へのデプロイ後にGitHub Actions上で正常に実行されることを確認します。

## 用語集

- **E2Eテストシステム**: Playwrightを使用したエンドツーエンドテストシステム
- **CDパイプライン**: GitHub Actionsで実行される継続的デプロイメントパイプライン
- **Webアプリケーション**: Next.js 16で構築されたフロントエンドアプリケーション
- **スモークテスト**: アプリケーションの基本的な動作を確認する最小限のテスト
- **Development環境**: AWSにデプロイされた開発環境（CloudFront + S3 + API Gateway + Lambda）

## 要件

### 要件1: Playwright環境のセットアップ

**ユーザーストーリー:** 開発者として、E2Eテストを書いて実行できるように、Playwrightをプロジェクトに設定したい

#### 受け入れ基準

1. E2Eテストシステムは、webパッケージにPlaywrightを開発依存関係としてインストールすること
2. E2Eテストシステムは、ブラウザ設定を含むPlaywright設定ファイルを作成すること
3. E2Eテストシステムは、GitHub Actions環境でChromiumブラウザを使用するようPlaywrightを設定すること
4. E2Eテストシステムは、ベースURLを環境変数から取得できるように設定すること
5. E2Eテストシステムは、テスト結果とスクリーンショット用の出力ディレクトリを設定すること

### 要件2: 基本的なスモークテストの実装

**ユーザーストーリー:** 開発者として、アプリケーションが正しく読み込まれることを確認できるように、基本的なスモークテストが欲しい

#### 受け入れ基準

1. ホームページにアクセスした時、E2Eテストシステムはページが正常に読み込まれることを検証すること
2. ホームページが読み込まれた時、E2Eテストシステムはページタイトルが存在することを検証すること
3. ホームページが読み込まれた時、E2Eテストシステムは少なくとも1つのインタラクティブ要素が表示されることを検証すること
4. E2Eテストシステムは、すべてのスモークテストを30秒以内に完了すること

### 要件3: GitHub Actionsワークフローの統合

**ユーザーストーリー:** 開発者として、Development環境へのデプロイを自動的に検証できるように、デプロイ後にE2Eテストを実行したい

#### 受け入れ基準

1. Development環境へのデプロイが成功した時、CDパイプラインはE2Eテストを実行すること
2. E2Eテストが実行される時、CDパイプラインはデプロイされたCloudFront URLを使用すること
3. E2Eテストが実行される時、CDパイプラインはPlaywrightブラウザをインストールすること
4. E2Eテストが完了した時、CDパイプラインはテスト結果をアーティファクトとしてアップロードすること
5. E2Eテストが失敗した場合、CDパイプラインはワークフローを失敗させること
6. E2Eテストが失敗した時、CDパイプラインはスクリーンショットをキャプチャしてアップロードすること
7. E2Eテストジョブは、Development環境へのデプロイ後にのみ実行されること（Staging、Productionでは実行しない）

### 要件4: テスト実行スクリプトの追加

**ユーザーストーリー:** 開発者として、GitHub Actionsでテストを実行できるように、E2Eテスト用のnpmスクリプトが欲しい

#### 受け入れ基準

1. E2Eテストシステムは、ヘッドレスモードでE2Eテストを実行するスクリプトを提供すること
2. E2Eテストシステムは、Playwrightブラウザをインストールするスクリプトを提供すること
3. GitHub Actions環境でテストが実行される時、E2Eテストシステムは自動的にヘッドレスモードを使用すること
4. E2Eテストシステムは、ベースURLを環境変数（BASE_URL）から取得すること

### 要件5: CI最適化とキャッシング

**ユーザーストーリー:** 開発者として、素早くフィードバックを得られるように、高速なCD実行が欲しい

#### 受け入れ基準

1. Playwrightブラウザがインストールされる時、CDパイプラインはブラウザバイナリをキャッシュすること
2. 依存関係がインストールされる時、CDパイプラインはキャッシュされたPlaywrightブラウザを再利用すること
3. CDパイプラインは、E2Eテストの実行時間を記録すること

### 要件6: テスト結果の可視性

**ユーザーストーリー:** 開発者として、失敗を素早くデバッグできるように、テスト結果を簡単に確認したい

#### 受け入れ基準

1. E2Eテストが完了した時、CDパイプラインはHTMLテストレポートを生成すること
2. E2Eテストが失敗した時、CDパイプラインは失敗時のスクリーンショットをアーティファクトとしてアップロードすること
3. E2Eテストが失敗した時、CDパイプラインはデバッグ用のトレースファイルをアップロードすること
4. CDパイプラインは、テストアーティファクトを7日間保持すること
5. E2Eテストが成功した時、CDパイプラインはデプロイサマリーにテスト結果を追加すること

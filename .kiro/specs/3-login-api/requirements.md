# 要件定義書

## はじめに

本ドキュメントは、投票ボードゲームアプリケーションのログインAPI機能の要件を定義します。ログインAPIは、登録済みユーザーがメールアドレスとパスワードを使用して認証し、アプリケーションにアクセスするためのJWTトークンを取得できるようにします。このAPIは、認証にAmazon Cognitoを、ユーザー情報の取得にDynamoDBを使用します。

## 用語集

- **ログインAPI**: ユーザー認証リクエストを処理するHTTP APIエンドポイント
- **Cognitoサービス**: ユーザー認証とIDを管理するAmazon Cognitoサービス
- **ユーザーリポジトリ**: ユーザー情報のDynamoDBデータアクセス層
- **アクセストークン**: API認証用の短期間有効なJWTトークン（15分）
- **リフレッシュトークン**: 新しいアクセストークンを取得するために使用される長期間有効なトークン
- **トークンリフレッシュAPI**: リフレッシュトークンを使用して新しいアクセストークンを取得するHTTP APIエンドポイント
- **メールアドレス**: ユーザーの一意の識別子として使用される有効なメールアドレス
- **パスワード**: ユーザーの秘密の認証情報
- **レート制限**: 不正アクセスを防ぐためのリクエスト頻度制限

## 要件

### 要件1: ログインエンドポイント

**ユーザーストーリー:** 登録済みユーザーとして、メールアドレスとパスワードを使用してログインし、ボードゲームの投票に参加したい。

#### 受け入れ基準

1. ログインAPIは、`/auth/login`エンドポイントでPOSTリクエストを受け付けなければならない
2. ログインリクエストを受信したとき、ログインAPIは、リクエストボディにemailとpasswordフィールドが含まれていることを検証しなければならない
3. emailフィールドが欠落または空の場合、ログインAPIは、エラーコード`VALIDATION_ERROR`を含む400ステータスコードを返さなければならない
4. passwordフィールドが欠落または空の場合、ログインAPIは、エラーコード`VALIDATION_ERROR`を含む400ステータスコードを返さなければならない

### 要件2: Cognito認証

**ユーザーストーリー:** 登録済みユーザーとして、正しい認証情報でログインし、安全にアプリケーションにアクセスしたい。

#### 受け入れ基準

1. すべての検証が通過したとき、ログインAPIは、提供されたメールアドレスとパスワードでCognitoサービスの`USER_PASSWORD_AUTH`フローを使用してユーザーを認証しなければならない
2. 認証が成功したとき、ログインAPIは、アクセストークン（15分有効）、リフレッシュトークン、IDトークンをCognitoサービスから取得しなければならない
3. メールアドレスまたはパスワードが正しくない場合、ログインAPIは、エラーコード`AUTHENTICATION_FAILED`とメッセージ「Invalid email or password」を含む401ステータスコードを返さなければならない
4. Cognitoサービスが予期しないエラーを返した場合、ログインAPIは、エラーコード`INTERNAL_ERROR`を含む500ステータスコードを返さなければならない

### 要件3: ユーザー情報の取得

**ユーザーストーリー:** クライアントアプリケーションとして、ログイン成功後にユーザー情報を受け取り、ユーザーのプロフィールを表示したい。

#### 受け入れ基準

1. 認証が成功したとき、ログインAPIは、CognitoのsubクレームからuserIdを抽出しなければならない
2. ログインAPIは、userIdを使用してDynamoDBからユーザーレコードを取得しなければならない
3. ユーザーレコードがDynamoDBに存在しない場合、ログインAPIは、エラーコード`USER_NOT_FOUND`を含む404ステータスコードを返さなければならない

### 要件4: ログイン成功レスポンス

**ユーザーストーリー:** クライアントアプリケーションとして、ログイン成功後に完全なユーザー情報とトークンを受け取り、ユーザーを認証してプロフィールを表示したい。

#### 受け入れ基準

1. ログインが成功したとき、ログインAPIは、200ステータスコードを返さなければならない
2. レスポンスボディは、userId、email、username、accessToken、refreshToken、expiresInフィールドを含まなければならない
3. expiresInフィールドは、値900（15分を秒単位で表したもの）を含まなければならない
4. レスポンスは、Content-Type `application/json`を使用しなければならない

### 要件5: トークンリフレッシュエンドポイント

**ユーザーストーリー:** 認証済みユーザーとして、アクセストークンの有効期限が切れた後も再ログインなしでアプリケーションを使い続けたい。

#### 受け入れ基準

1. トークンリフレッシュAPIは、`/auth/refresh`エンドポイントでPOSTリクエストを受け付けなければならない
2. リクエストボディにrefreshTokenフィールドが欠落または空の場合、トークンリフレッシュAPIは、エラーコード`VALIDATION_ERROR`を含む400ステータスコードを返さなければならない
3. 有効なリフレッシュトークンを受信したとき、トークンリフレッシュAPIは、Cognitoサービスの`REFRESH_TOKEN_AUTH`フローを使用して新しいアクセストークンを取得しなければならない
4. トークンリフレッシュが成功したとき、トークンリフレッシュAPIは、accessToken、expiresInフィールドを含む200ステータスコードのレスポンスを返さなければならない
5. リフレッシュトークンが無効または期限切れの場合、トークンリフレッシュAPIは、エラーコード`TOKEN_EXPIRED`とメッセージ「Refresh token is invalid or expired」を含む401ステータスコードを返さなければならない

### 要件6: レート制限

**ユーザーストーリー:** システム管理者として、ログインエンドポイントへのブルートフォース攻撃を防ぎ、正当なユーザーがシステムを利用できるようにしたい。

#### 受け入れ基準

1. ログインAPIは、IPアドレスごとに1分あたり10リクエストのレート制限を適用しなければならない
2. トークンリフレッシュAPIは、IPアドレスごとに1分あたり20リクエストのレート制限を適用しなければならない
3. レート制限を超えたとき、ログインAPIは、エラーコード`RATE_LIMIT_EXCEEDED`を含む429ステータスコードを返さなければならない
4. レスポンスは、次のリクエストが許可されるまでの秒数を示す`retryAfter`フィールドを含まなければならない

### 要件7: エラーレスポンス形式

**ユーザーストーリー:** クライアントアプリケーション開発者として、一貫したエラーレスポンスを受け取り、エラーを予測可能に処理し、ユーザーに明確なフィードバックを提供したい。

#### 受け入れ基準

1. エラーが発生したとき、ログインAPIは、error、message、オプションのdetailsフィールドを含むJSONレスポンスを返さなければならない
2. errorフィールドは、機械可読なエラーコードを含まなければならない
3. messageフィールドは、人間が読めるエラー説明を含まなければならない
4. 検証エラーが発生した場合、detailsフィールドは、フィールド名をエラーメッセージにマッピングするfieldsオブジェクトを含まなければならない

### 要件8: セキュリティ対策

**ユーザーストーリー:** セキュリティを重視するユーザーとして、ログイン処理が安全に行われ、認証情報が保護されることを望む。

#### 受け入れ基準

1. ログインAPIは、認証失敗時にメールアドレスの存在有無を明らかにしてはならない（「Invalid email or password」という統一メッセージを使用）
2. ログインAPIは、パスワードをログに出力してはならない
3. ログインAPIは、トークンをログに出力してはならない
4. ログインAPIは、メールアドレスをマスクしてログに記録しなければならない

### 要件9: リクエストログ

**ユーザーストーリー:** システム管理者として、ログイン試行がログに記録され、不正アクセスの監視と問題の調査ができるようにしたい。

#### 受け入れ基準

1. ログインリクエストを受信したとき、ログインAPIは、タイムスタンプ、メールアドレス（マスク済み）、IPアドレスを含むリクエストをログに記録しなければならない
2. ログインが成功したとき、ログインAPIは、userIdとタイムスタンプを含む成功イベントをログに記録しなければならない
3. ログインが失敗したとき、ログインAPIは、エラーコード、タイムスタンプを含む失敗イベントをログに記録しなければならない

### 要件10: CORS設定

**ユーザーストーリー:** Webアプリケーションとして、ブラウザからログインAPIを呼び出し、バックエンドプロキシなしでユーザーがログインできるようにしたい。

#### 受け入れ基準

1. ログインAPIは、レスポンスにCORSヘッダーを含まなければならない
2. ログインAPIは、開発環境用に`http://localhost:3000`からのリクエストを許可しなければならない
3. ログインAPIは、ステージング環境用に`https://stg.vote-board-game.example.com`からのリクエストを許可しなければならない
4. ログインAPIは、本番環境用に`https://vote-board-game.example.com`からのリクエストを許可しなければならない
5. ログインAPIは、POSTメソッドとContent-Typeヘッダーを許可しなければならない

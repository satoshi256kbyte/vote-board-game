# 要件定義書

## はじめに

本ドキュメントは、投票ボードゲームアプリケーションのJWTトークン検証ミドルウェアの要件を定義します。JWTトークン検証ミドルウェアは、Amazon Cognitoが発行するJWTトークン（アクセストークン）を検証し、認証が必要なAPIエンドポイントを保護します。Honoミドルウェアとして実装し、保護対象のルートに適用することで、未認証リクエストを拒否し、認証済みユーザー情報をリクエストコンテキストに付与します。

## 用語集

- **JWTトークン検証ミドルウェア**: Honoミドルウェアとして動作し、リクエストのAuthorizationヘッダーからJWTトークンを抽出・検証するコンポーネント
- **アクセストークン**: Amazon Cognitoが発行するJWT形式のトークンで、APIリクエストの認証に使用される
- **JWKS（JSON Web Key Set）**: Cognitoが公開するJWTトークンの署名検証に使用する公開鍵のセット
- **Authorizationヘッダー**: HTTPリクエストヘッダーで、`Bearer <token>` 形式でアクセストークンを含む
- **認証コンテキスト**: ミドルウェアが検証済みトークンから抽出し、後続のハンドラーに渡すユーザー情報（userId、email等）
- **保護ルート**: JWTトークン検証が必要なAPIエンドポイント（投票、候補投稿など）
- **公開ルート**: JWTトークン検証が不要なAPIエンドポイント（ゲーム一覧、盤面取得、認証エンドポイントなど）
- **トークン有効期限**: アクセストークンの有効期間（Cognito設定に基づき15分）
- **JWKSキャッシュ**: JWKSエンドポイントへのリクエストを削減するためのインメモリキャッシュ

## 要件

### 要件1: Authorizationヘッダーからのトークン抽出

**ユーザーストーリー:** 認証済みユーザーとして、APIリクエストにアクセストークンを含めて送信し、保護されたリソースにアクセスしたい。

#### 受け入れ基準

1. WHEN HTTPリクエストを受信したとき、THE JWTトークン検証ミドルウェア SHALL Authorizationヘッダーから`Bearer <token>`形式のトークンを抽出しなければならない
2. IF Authorizationヘッダーが存在しない場合、THEN THE JWTトークン検証ミドルウェア SHALL エラーコード`UNAUTHORIZED`とメッセージ「Authorization header is required」を含む401ステータスコードを返さなければならない
3. IF Authorizationヘッダーが`Bearer `プレフィックスで始まらない場合、THEN THE JWTトークン検証ミドルウェア SHALL エラーコード`UNAUTHORIZED`とメッセージ「Invalid authorization format」を含む401ステータスコードを返さなければならない
4. IF `Bearer `プレフィックスの後にトークン文字列が空の場合、THEN THE JWTトークン検証ミドルウェア SHALL エラーコード`UNAUTHORIZED`とメッセージ「Token is required」を含む401ステータスコードを返さなければならない

### 要件2: JWTトークンの署名検証

**ユーザーストーリー:** システム管理者として、改ざんされたトークンや不正なトークンを拒否し、正当なCognitoが発行したトークンのみを受け入れたい。

#### 受け入れ基準

1. WHEN トークンを検証するとき、THE JWTトークン検証ミドルウェア SHALL CognitoのJWKSエンドポイント（`https://cognito-idp.{region}.amazonaws.com/{userPoolId}/.well-known/jwks.json`）から公開鍵を取得しなければならない
2. WHEN トークンを検証するとき、THE JWTトークン検証ミドルウェア SHALL トークンヘッダーの`kid`（Key ID）に一致する公開鍵を使用して署名を検証しなければならない
3. IF トークンの署名が無効な場合、THEN THE JWTトークン検証ミドルウェア SHALL エラーコード`UNAUTHORIZED`とメッセージ「Invalid token」を含む401ステータスコードを返さなければならない
4. IF トークンヘッダーの`kid`に一致する公開鍵がJWKSに存在しない場合、THEN THE JWTトークン検証ミドルウェア SHALL エラーコード`UNAUTHORIZED`とメッセージ「Invalid token」を含む401ステータスコードを返さなければならない

### 要件3: JWTトークンのクレーム検証

**ユーザーストーリー:** システム管理者として、トークンの発行元、有効期限、用途が正しいことを検証し、不正なトークンの使用を防ぎたい。

#### 受け入れ基準

1. WHEN トークンのクレームを検証するとき、THE JWTトークン検証ミドルウェア SHALL `iss`（発行者）クレームが`https://cognito-idp.{region}.amazonaws.com/{userPoolId}`と一致することを検証しなければならない
2. WHEN トークンのクレームを検証するとき、THE JWTトークン検証ミドルウェア SHALL `token_use`クレームが`access`であることを検証しなければならない
3. WHEN トークンのクレームを検証するとき、THE JWTトークン検証ミドルウェア SHALL `exp`（有効期限）クレームが現在時刻より未来であることを検証しなければならない
4. IF `iss`クレームが期待値と一致しない場合、THEN THE JWTトークン検証ミドルウェア SHALL エラーコード`UNAUTHORIZED`とメッセージ「Invalid token」を含む401ステータスコードを返さなければならない
5. IF `token_use`クレームが`access`でない場合、THEN THE JWTトークン検証ミドルウェア SHALL エラーコード`UNAUTHORIZED`とメッセージ「Invalid token」を含む401ステータスコードを返さなければならない
6. IF トークンの有効期限が切れている場合、THEN THE JWTトークン検証ミドルウェア SHALL エラーコード`TOKEN_EXPIRED`とメッセージ「Token has expired」を含む401ステータスコードを返さなければならない

### 要件4: 認証コンテキストの設定

**ユーザーストーリー:** バックエンド開発者として、検証済みトークンからユーザー情報を取得し、後続のハンドラーでユーザー固有の処理を実行したい。

#### 受け入れ基準

1. WHEN トークンの検証が成功したとき、THE JWTトークン検証ミドルウェア SHALL トークンの`sub`クレームをuserIdとしてHonoのコンテキスト変数に設定しなければならない
2. WHEN トークンの検証が成功したとき、THE JWTトークン検証ミドルウェア SHALL トークンの`email`クレーム（存在する場合）をemailとしてHonoのコンテキスト変数に設定しなければならない
3. WHEN トークンの検証が成功したとき、THE JWTトークン検証ミドルウェア SHALL トークンの`preferred_username`クレーム（存在する場合）をusernameとしてHonoのコンテキスト変数に設定しなければならない
4. WHEN 認証コンテキストが設定された後、THE JWTトークン検証ミドルウェア SHALL 後続のハンドラーに処理を渡さなければならない（`await next()`を呼び出す）

### 要件5: JWKSキャッシュ

**ユーザーストーリー:** システム管理者として、JWKSエンドポイントへの過剰なリクエストを防ぎ、トークン検証のレイテンシを低減したい。

#### 受け入れ基準

1. THE JWTトークン検証ミドルウェア SHALL JWKSレスポンスをインメモリにキャッシュしなければならない
2. THE JWTトークン検証ミドルウェア SHALL キャッシュの有効期間を1時間に設定しなければならない
3. WHEN キャッシュが有効期間内の場合、THE JWTトークン検証ミドルウェア SHALL キャッシュされたJWKSを使用してトークンを検証しなければならない
4. WHEN キャッシュが期限切れの場合、THE JWTトークン検証ミドルウェア SHALL JWKSエンドポイントから新しい公開鍵を取得してキャッシュを更新しなければならない
5. IF JWKSエンドポイントへのリクエストが失敗し、かつ期限切れのキャッシュが存在する場合、THEN THE JWTトークン検証ミドルウェア SHALL 期限切れのキャッシュを使用してトークン検証を継続しなければならない
6. IF JWKSエンドポイントへのリクエストが失敗し、かつキャッシュが存在しない場合、THEN THE JWTトークン検証ミドルウェア SHALL エラーコード`INTERNAL_ERROR`とメッセージ「Authentication service unavailable」を含む500ステータスコードを返さなければならない

### 要件6: ルートの保護設定

**ユーザーストーリー:** バックエンド開発者として、認証が必要なルートと不要なルートを明確に区別し、適切にミドルウェアを適用したい。

#### 受け入れ基準

1. THE JWTトークン検証ミドルウェア SHALL 投票エンドポイント（`/api/votes`配下）に適用されなければならない
2. THE JWTトークン検証ミドルウェア SHALL 候補投稿エンドポイント（`POST /api/candidates`）に適用されなければならない
3. THE JWTトークン検証ミドルウェア SHALL ゲーム一覧取得（`GET /api/games`）、ゲーム詳細取得（`GET /api/games/:gameId`）、盤面取得（`GET /api/games/:gameId/board`）、対局履歴取得（`GET /api/games/:gameId/history`）には適用してはならない
4. THE JWTトークン検証ミドルウェア SHALL 候補一覧取得（`GET /api/candidates`）には適用してはならない
5. THE JWTトークン検証ミドルウェア SHALL 認証エンドポイント（`/auth`配下）には適用してはならない
6. THE JWTトークン検証ミドルウェア SHALL ヘルスチェックエンドポイント（`GET /health`）には適用してはならない

### 要件7: エラーレスポンス形式

**ユーザーストーリー:** クライアントアプリケーション開発者として、認証エラーを一貫した形式で受け取り、適切なエラーハンドリングを実装したい。

#### 受け入れ基準

1. WHEN 認証エラーが発生したとき、THE JWTトークン検証ミドルウェア SHALL errorフィールドとmessageフィールドを含むJSONレスポンスを返さなければならない
2. THE JWTトークン検証ミドルウェア SHALL 認証エラーのerrorフィールドに`UNAUTHORIZED`または`TOKEN_EXPIRED`の機械可読なエラーコードを使用しなければならない
3. THE JWTトークン検証ミドルウェア SHALL 認証エラーのmessageフィールドに人間が読めるエラー説明を含まなければならない
4. THE JWTトークン検証ミドルウェア SHALL 認証エラーのレスポンスにトークンの内容や検証失敗の詳細な理由を含めてはならない（セキュリティ上の理由）

### 要件8: セキュリティ対策

**ユーザーストーリー:** システム管理者として、トークン検証プロセスが安全に行われ、機密情報が漏洩しないことを保証したい。

#### 受け入れ基準

1. THE JWTトークン検証ミドルウェア SHALL トークン文字列をログに出力してはならない
2. THE JWTトークン検証ミドルウェア SHALL トークンのペイロード全体をログに出力してはならない
3. IF 認証エラーが発生した場合、THEN THE JWTトークン検証ミドルウェア SHALL エラーの種類（署名不正、期限切れ、クレーム不正等）をログに記録しなければならない
4. THE JWTトークン検証ミドルウェア SHALL 環境変数`COGNITO_USER_POOL_ID`と`AWS_REGION`を使用してJWKSエンドポイントURLを構築しなければならない
5. IF 必要な環境変数が設定されていない場合、THEN THE JWTトークン検証ミドルウェア SHALL アプリケーション起動時にエラーを報告しなければならない

### 要件9: 型安全性

**ユーザーストーリー:** バックエンド開発者として、認証コンテキストの型が定義され、TypeScriptの型チェックによって安全にユーザー情報にアクセスしたい。

#### 受け入れ基準

1. THE JWTトークン検証ミドルウェア SHALL 認証コンテキストの型定義（userId、email、username）をエクスポートしなければならない
2. THE JWTトークン検証ミドルウェア SHALL Honoの型システムと統合し、`c.get('userId')`等の呼び出しで型安全にユーザー情報を取得できなければならない
3. THE JWTトークン検証ミドルウェア SHALL `any`型を使用してはならない

# 要件定義書

## はじめに

本ドキュメントは、投票ボードゲームアプリケーションの主要なユーザーフローに対するE2E（エンドツーエンド）テストの要件を定義します。E2Eテストは、Playwrightを使用してブラウザの観点から重要なユーザージャーニーを検証し、フロントエンド、API、データベース層にわたって統合されたシステムが正しく動作することを保証します。

スコープはMVPに必要な最小限の重要なフローに限定され、ユーザー認証、ゲーム参加、投票機能に焦点を当てます。

## 用語集

- **E2E_Test_Suite（E2Eテストスイート）**: エンドツーエンドのユーザーフローを検証するPlaywrightテストの集合
- **Test_Runner（テストランナー）**: Playwrightのテスト実行エンジン
- **Authentication_Flow（認証フロー）**: ユーザー登録、ログイン、ログアウト操作の一連の流れ
- **Game_Flow（ゲームフロー）**: ゲーム一覧表示、ゲーム参加、ゲーム詳細表示の一連の流れ
- **Voting_Flow（投票フロー）**: 次の一手候補の表示、投票送信、投票結果表示の一連の流れ
- **Profile_Flow（プロフィールフロー）**: ユーザープロフィール情報の表示と更新の一連の流れ
- **Password_Reset_Flow（パスワードリセットフロー）**: パスワードリセットの要求と完了の一連の流れ
- **Test_Environment（テスト環境）**: E2Eテストが実行される隔離された環境（本番環境とは分離）
- **Test_Data（テストデータ）**: テスト実行に使用されるモックまたはシードデータ
- **Test_Report（テストレポート）**: テスト実行結果、合格/不合格ステータス、スクリーンショットを示す出力ドキュメント
- **Headless_Mode（ヘッドレスモード）**: UIを表示しないブラウザ実行モード（CI/CD用）
- **Visual_Mode（ビジュアルモード）**: UIを表示するブラウザ実行モード（デバッグ用）

## 要件

### 要件1: 認証フローのテスト

**ユーザーストーリー:** QAエンジニアとして、完全な認証フローをテストしたい。そうすることで、ユーザーが正しく登録、ログイン、ログアウトできることを検証できる。

#### 受け入れ基準

1. WHEN 新規ユーザーが有効なデータで登録フォームを完了する、THE E2E_Test_Suite SHALL ユーザーがログインページにリダイレクトされることを検証する
2. WHEN 登録済みユーザーが有効な認証情報を送信する、THE E2E_Test_Suite SHALL ユーザーがゲーム一覧ページにリダイレクトされることを検証する
3. WHEN ログイン済みユーザーがログアウトボタンをクリックする、THE E2E_Test_Suite SHALL ユーザーがログインページにリダイレクトされることを検証する
4. WHEN ユーザーが無効な認証情報を送信する、THE E2E_Test_Suite SHALL エラーメッセージが表示されることを検証する
5. WHEN ユーザーが認証なしで保護されたページにアクセスしようとする、THE E2E_Test_Suite SHALL ユーザーがログインページにリダイレクトされることを検証する

### 要件2: パスワードリセットフローのテスト

**ユーザーストーリー:** QAエンジニアとして、パスワードリセットフローをテストしたい。そうすることで、ユーザーがアカウントを回復できることを検証できる。

#### 受け入れ基準

1. WHEN ユーザーがパスワードリセット要求ページで有効なメールアドレスを送信する、THE E2E_Test_Suite SHALL 確認メッセージが表示されることを検証する
2. WHEN ユーザーがパスワードリセット要求ページで無効なメールアドレスを送信する、THE E2E_Test_Suite SHALL エラーメッセージが表示されることを検証する
3. WHEN ユーザーが有効なリセットトークンと新しいパスワードでパスワードリセットフォームを完了する、THE E2E_Test_Suite SHALL ユーザーがログインページにリダイレクトされることを検証する
4. WHEN ユーザーが期限切れまたは無効なリセットトークンを使用しようとする、THE E2E_Test_Suite SHALL エラーメッセージが表示されることを検証する

### 要件3: ゲーム閲覧と参加フローのテスト

**ユーザーストーリー:** QAエンジニアとして、ゲーム閲覧と参加フローをテストしたい。そうすることで、ユーザーがゲームを閲覧して参加できることを検証できる。

#### 受け入れ基準

1. WHEN ログイン済みユーザーがゲーム一覧ページに移動する、THE E2E_Test_Suite SHALL 少なくとも1つのアクティブなゲームが表示されることを検証する
2. WHEN ユーザーが一覧からゲームをクリックする、THE E2E_Test_Suite SHALL ゲーム詳細ページに現在の盤面状態が表示されることを検証する
3. WHEN ユーザーがゲーム詳細ページでゲーム参加ボタンをクリックする、THE E2E_Test_Suite SHALL ユーザーが投票インターフェースにアクセスできることを検証する
4. WHEN ユーザーがゲーム詳細ページを表示する、THE E2E_Test_Suite SHALL 手の履歴が表示されることを検証する
5. WHEN ユーザーがゲーム詳細ページを表示する、THE E2E_Test_Suite SHALL AIによる解説が表示されることを検証する

### 要件4: 投票フローのテスト

**ユーザーストーリー:** QAエンジニアとして、投票フローをテストしたい。そうすることで、ユーザーが次の一手候補に正しく投票できることを検証できる。

#### 受け入れ基準

1. WHEN ログイン済みユーザーがアクティブなゲームの投票ページに移動する、THE E2E_Test_Suite SHALL 次の一手候補が表示されることを検証する
2. WHEN ユーザーが次の一手候補を選択して投票を送信する、THE E2E_Test_Suite SHALL 成功確認が表示されることを検証する
3. WHEN ユーザーが同じ投票期間中に同じゲームに2回投票しようとする、THE E2E_Test_Suite SHALL エラーメッセージが表示されることを検証する
4. WHEN ユーザーが次の一手候補を表示する、THE E2E_Test_Suite SHALL 各候補の説明文が表示されることを検証する
5. WHEN ユーザーが有効なデータで新しい次の一手候補を送信する、THE E2E_Test_Suite SHALL 候補が候補一覧に表示されることを検証する
6. WHEN ユーザーが無効なデータで次の一手候補を送信しようとする、THE E2E_Test_Suite SHALL エラーメッセージが表示されることを検証する

### 要件5: プロフィール管理フローのテスト

**ユーザーストーリー:** QAエンジニアとして、プロフィール管理フローをテストしたい。そうすることで、ユーザーがプロフィールを表示して更新できることを検証できる。

#### 受け入れ基準

1. WHEN ログイン済みユーザーがプロフィールページに移動する、THE E2E_Test_Suite SHALL ユーザーの現在のプロフィール情報が表示されることを検証する
2. WHEN ユーザーが有効なデータでプロフィールを更新して送信する、THE E2E_Test_Suite SHALL 成功確認が表示されることを検証する
3. WHEN ユーザーが無効なデータでプロフィールを更新して送信する、THE E2E_Test_Suite SHALL エラーメッセージが表示されることを検証する
4. WHEN ユーザーがプロフィールページを表示する、THE E2E_Test_Suite SHALL 投票履歴が表示されることを検証する

### 要件6: テスト実行環境

**ユーザーストーリー:** 開発者として、E2Eテストを隔離された環境で実行したい。そうすることで、テスト実行が本番データに影響を与えないようにできる。

#### 受け入れ基準

1. THE E2E_Test_Suite SHALL 隔離されたテストデータを持つTest_Environmentに対して実行する
2. WHEN E2EテストがCI/CDパイプラインで実行される、THE Test_Runner SHALL Headless_Modeで実行する
3. WHEN 開発者がローカルでE2Eテストを実行する、THE Test_Runner SHALL Headless_ModeとVisual_Modeの両方をサポートする
4. WHEN E2Eテストが実行を完了する、THE Test_Runner SHALL 合格/不合格ステータスを含むTest_Reportを生成する
5. IF テストが失敗する、THEN THE Test_Runner SHALL スクリーンショットをキャプチャしてTest_Reportに含める

### 要件7: テストデータ管理

**ユーザーストーリー:** 開発者として、テストデータを自動的にセットアップしてクリーンアップしたい。そうすることで、テストが信頼性が高く再現可能になる。

#### 受け入れ基準

1. WHEN E2E_Test_Suiteが実行を開始する、THE Test_Runner SHALL 必要なTest_DataをTest_Environmentにシードする
2. WHEN E2E_Test_Suiteが実行を完了する、THE Test_Runner SHALL Test_EnvironmentからTest_Dataをクリーンアップする
3. THE E2E_Test_Suite SHALL 競合を避けるために各テスト実行ごとに一意のテストユーザーを作成する
4. THE E2E_Test_Suite SHALL 投票テスト用に次の一手候補を持つ少なくとも1つのアクティブなゲームを作成する
5. THE E2E_Test_Suite SHALL 現実的なゲーム状態を表すテストデータを作成する

### 要件8: テスト実行パフォーマンス

**ユーザーストーリー:** 開発者として、E2Eテストを効率的に実行したい。そうすることで、CI/CDパイプラインが迅速に完了する。

#### 受け入れ基準

1. WHEN 完全なE2E_Test_Suiteが実行される、THE Test_Runner SHALL 10分以内に完了する
2. WHEN 単一の認証テストが実行される、THE Test_Runner SHALL 30秒以内に完了する
3. WHEN 単一の投票フローテストが実行される、THE Test_Runner SHALL 45秒以内に完了する
4. THE E2E_Test_Suite SHALL 独立したテストケースの並列テスト実行をサポートする
5. IF テストがタイムアウト閾値を超える、THEN THE Test_Runner SHALL テストを失敗させて残りのテストを続行する

### 要件9: クロスブラウザ互換性テスト

**ユーザーストーリー:** QAエンジニアとして、複数のブラウザでテストを実行したい。そうすることで、アプリケーションが異なるプラットフォームで動作することを検証できる。

#### 受け入れ基準

1. THE E2E_Test_Suite SHALL Chromiumブラウザでテストを実行する
2. THE E2E_Test_Suite SHALL Firefoxブラウザでテストを実行する
3. THE E2E_Test_Suite SHALL WebKitブラウザでテストを実行する
4. WHEN テストが異なるブラウザで実行される、THE Test_Runner SHALL 各ブラウザごとに個別のTest_Reportを生成する
5. WHERE CI/CDパイプライン実行が設定されている、THE E2E_Test_Suite SHALL 3つすべてのブラウザで実行する

### 要件10: テストの信頼性と安定性

**ユーザーストーリー:** 開発者として、E2Eテストを信頼性が高く安定したものにしたい。そうすることで、テストの失敗が不安定なテストではなく実際の問題を示すようになる。

#### 受け入れ基準

1. WHEN E2E_Test_Suiteが要素を待機する、THE Test_Runner SHALL 適切なタイムアウト値を持つ明示的な待機を使用する
2. WHEN E2E_Test_Suiteが動的コンテンツと対話する、THE Test_Runner SHALL ネットワークリクエストの完了を待機する
3. THE E2E_Test_Suite SHALL テストを失敗としてマークする前に、失敗したアサーションを最大3回再試行する
4. THE E2E_Test_Suite SHALL CSSクラスではなくdata-testid属性に基づく安定したセレクタを使用する
5. WHEN テストがAPIと対話する、THE E2E_Test_Suite SHALL 続行する前にローディング状態の完了を待機する

### 要件11: ソーシャルシェアフローのテスト

**ユーザーストーリー:** QAエンジニアとして、ソーシャルシェア機能をテストしたい。そうすることで、シェアリンクとOGP画像が正しく動作することを検証できる。

#### 受け入れ基準

1. WHEN ユーザーがゲーム詳細ページでシェアボタンをクリックする、THE E2E_Test_Suite SHALL シェアURLが生成されることを検証する
2. WHEN ユーザーが共有されたゲームURLにアクセスする、THE E2E_Test_Suite SHALL 正しいゲーム状態が表示されることを検証する
3. WHEN ユーザーが共有された次の一手候補URLにアクセスする、THE E2E_Test_Suite SHALL 正しい候補の詳細が表示されることを検証する
4. WHEN E2E_Test_Suiteが共有URLをリクエストする、THE Test_Runner SHALL OGPメタタグがHTMLに存在することを検証する
5. WHEN E2E_Test_Suiteが共有URLをリクエストする、THE Test_Runner SHALL OGP画像URLが有効な画像を返すことを検証する

### 要件12: エラーハンドリングとエッジケース

**ユーザーストーリー:** QAエンジニアとして、エラーシナリオとエッジケースをテストしたい。そうすることで、アプリケーションが障害を適切に処理することを検証できる。

#### 受け入れ基準

1. WHEN E2E_Test_Suiteが投票中のネットワーク障害をシミュレートする、THE Test_Runner SHALL 適切なエラーメッセージが表示されることを検証する
2. WHEN E2E_Test_Suiteがセッションタイムアウトをシミュレートする、THE Test_Runner SHALL ユーザーがログインページにリダイレクトされることを検証する
3. WHEN ユーザーが投票期間終了後に投票しようとする、THE E2E_Test_Suite SHALL エラーメッセージが表示されることを検証する
4. WHEN ユーザーが存在しないゲームにアクセスしようとする、THE E2E_Test_Suite SHALL 404エラーページが表示されることを検証する
5. WHEN E2E_Test_Suiteが必須フィールドが欠けているフォームを送信する、THE Test_Runner SHALL バリデーションエラーメッセージが表示されることを検証する

# 実装計画: ログイン画面

## 概要

本ドキュメントは、投票ボードゲームアプリケーションのログイン画面機能の実装タスクを定義します。この機能は、Next.js 16 App Router、React 19、TypeScript、Tailwind CSS、shadcn/uiを使用して構築されます。既存のログインAPI（`/auth/login`）と統合し、認証成功後にユーザーをホーム画面に遷移させます。

実装は、基盤となるサービスとコンテキストから始め、UIコンポーネントへと段階的に構築していきます。各ステップでは、コア機能を早期に検証し、テストを通じて品質を確保します。

## タスク

- [x] 1. プロジェクト構造とUIコンポーネントのセットアップ
  - `packages/web/src/components/ui/`ディレクトリにshadcn/uiコンポーネント（Button、Input、Alert）を追加
  - 必要に応じて`npx shadcn-ui@latest add button input alert`を実行
  - _要件: 1.1, 1.2, 1.3_

- [ ] 2. Storage Serviceの実装
  - [x] 2.1 Storage Serviceの実装
    - `packages/web/src/lib/services/storage-service.ts`を作成
    - アクセストークンとリフレッシュトークンの保存・取得・削除機能を実装
    - ローカルストレージキー: `vbg_access_token`, `vbg_refresh_token`
    - SSR対応（`typeof window !== 'undefined'`チェック）
    - _要件: 4.2_

  - [x] 2.2 Storage Serviceのユニットテスト
    - `packages/web/src/lib/services/storage-service.test.ts`を作成
    - トークンの保存・取得・削除のテスト
    - SSR環境でのnullチェックのテスト
    - _要件: 4.2_

- [ ] 3. Auth Contextの実装
  - [x] 3.1 Auth Contextの実装
    - `packages/web/src/lib/contexts/auth-context.tsx`を作成
    - ユーザー情報の状態管理（User型: userId, email, username）
    - AuthProviderコンポーネントの実装
    - 初期化時のトークン存在確認
    - _要件: 4.3_

  - [x] 3.2 Auth Contextのユニットテスト
    - `packages/web/src/lib/contexts/auth-context.test.tsx`を作成
    - ユーザー情報の設定・取得のテスト
    - 認証状態の判定テスト
    - _要件: 4.3_

- [ ] 4. Auth Serviceの実装
  - [x] 4.1 Auth Serviceの実装
    - `packages/web/src/lib/services/auth-service.ts`を作成
    - login関数の実装（メールアドレス、パスワードを受け取り、ログインAPIを呼び出し）
    - エラーレスポンスの変換（401、429、500、ネットワークエラー）
    - トークンのローカルストレージへの保存
    - 環境変数`NEXT_PUBLIC_API_URL`の使用
    - _要件: 3.1, 4.1, 4.2, 5.1, 5.2, 5.3, 5.4_

  - [x] 4.2 Auth Serviceのユニットテスト
    - `packages/web/src/lib/services/auth-service.test.ts`を作成
    - ログイン成功時のテスト（200レスポンス）
    - エラーレスポンスの変換テスト（401、429、500）
    - ネットワークエラーのテスト
    - トークン保存の検証
    - _要件: 3.1, 4.1, 4.2, 5.1, 5.2, 5.3, 5.4_

  - [x] 4.3 Auth Serviceのプロパティベーステスト
    - `packages/web/src/lib/services/auth-service.property.test.ts`を作成
    - **プロパティ4: トークンのローカルストレージ保存**
    - **検証: 要件 4.2**
    - fast-checkを使用して、任意のログイン成功レスポンスに対してトークンが正しく保存されることを検証
    - _要件: 4.2_

- [~] 5. チェックポイント - 基盤サービスの動作確認
  - すべてのテストが通過することを確認し、質問があればユーザーに尋ねる

- [ ] 6. useAuthフックの実装
  - [~] 6.1 useAuthフックの実装
    - `packages/web/src/lib/hooks/use-auth.ts`を作成
    - Auth Contextへのアクセスを提供
    - コンテキスト外での使用時のエラーハンドリング
    - _要件: 4.3_

  - [~] 6.2 useAuthフックのユニットテスト
    - `packages/web/src/lib/hooks/use-auth.test.tsx`を作成
    - AuthProvider内での使用テスト
    - コンテキスト外での使用時のエラーテスト
    - _要件: 4.3_

- [ ] 7. useLoginフックの実装
  - [~] 7.1 useLoginフックの実装
    - `packages/web/src/lib/hooks/use-login.ts`を作成
    - ログインロジックのカプセル化（login関数）
    - ローディング状態とエラー状態の管理
    - Auth Serviceの呼び出し
    - useAuthフックを使用してユーザー情報を保存
    - _要件: 3.1, 3.2, 4.3, 5.1, 5.2, 5.3, 5.4, 5.5_

  - [~] 7.2 useLoginフックのユニットテスト
    - `packages/web/src/lib/hooks/use-login.test.tsx`を作成
    - ログイン成功時のテスト
    - ログイン失敗時のエラーハンドリングテスト
    - ローディング状態の遷移テスト
    - _要件: 3.1, 3.2, 4.3, 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 8. LoginFormコンポーネントの実装
  - [~] 8.1 LoginFormコンポーネントの実装
    - `packages/web/src/components/auth/login-form.tsx`を作成
    - メールアドレスとパスワードの入力フィールド
    - クライアント側バリデーション（空フィールド、無効なメールアドレス形式）
    - ログインボタンとローディング状態の管理
    - エラーメッセージの表示（バリデーションエラー、APIエラー）
    - パスワード表示切り替えボタン（目のアイコン）
    - パスワードリセットリンク（`/password-reset`）
    - 新規登録リンク（`/register`）
    - ARIA属性の設定（aria-label、aria-invalid、aria-describedby、role="alert"、aria-disabled）
    - useLoginフックの使用
    - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4, 4.4, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 7.1, 7.2, 9.1, 9.2, 9.3, 9.4, 10.1, 10.2, 10.3, 10.4, 10.5_

  - [~] 8.2 LoginFormコンポーネントのユニットテスト
    - `packages/web/src/components/auth/login-form.test.tsx`を作成
    - 初期表示のテスト（フォーム要素の存在確認）
    - 空フィールドのバリデーションテスト
    - ローディング状態のUI変更テスト
    - ログイン成功フローのテスト
    - パスワードリセットリンクのテスト
    - 新規登録リンクのテスト
    - パスワード表示切り替えのテスト
    - ARIA属性のテスト
    - レスポンシブレイアウトのテスト
    - _要件: 1.1-1.6, 2.1, 2.2, 3.2, 3.3, 3.4, 4.1, 4.3, 4.4, 6.1, 6.2, 7.1, 7.2, 9.1, 9.2, 9.4, 10.1, 10.2, 10.4, 10.5, 11.2, 11.3_

  - [~] 8.3 LoginFormコンポーネントのプロパティベーステスト
    - `packages/web/src/components/auth/login-form.property.test.tsx`を作成
    - **プロパティ1: 無効なメールアドレス形式のバリデーション**
    - **検証: 要件 2.3**
    - **プロパティ2: バリデーションエラー時のAPI呼び出し防止**
    - **検証: 要件 2.4**
    - **プロパティ3: 有効な入力でのAPI呼び出し**
    - **検証: 要件 3.1**
    - **プロパティ5: APIエラーメッセージの表示**
    - **検証: 要件 5.1, 5.2, 5.3, 5.4**
    - **プロパティ6: エラー後のフォーム再有効化**
    - **検証: 要件 5.5**
    - **プロパティ7: パスワード表示切り替えのラウンドトリップ**
    - **検証: 要件 9.3**
    - **プロパティ8: バリデーションエラー時のrole="alert"属性**
    - **検証: 要件 10.3**
    - **プロパティ9: タッチ可能要素の最小サイズ**
    - **検証: 要件 11.4**
    - fast-checkを使用して各プロパティを検証
    - _要件: 2.3, 2.4, 3.1, 5.1, 5.2, 5.3, 5.4, 5.5, 9.3, 10.3, 11.4_

- [ ] 9. Login Pageコンポーネントの実装
  - [~] 9.1 Login Pageコンポーネントの実装
    - `packages/web/src/app/login/page.tsx`を作成
    - 'use client'ディレクティブを追加
    - 認証済みユーザーのリダイレクト処理（トークン存在確認）
    - リダイレクト中のローディングインジケーター表示
    - LoginFormコンポーネントのレンダリング
    - レスポンシブレイアウト（中央配置、最大幅400px）
    - _要件: 8.1, 8.2, 8.3, 11.2, 11.3_

  - [~] 9.2 Login Pageコンポーネントのユニットテスト
    - `packages/web/src/app/login/page.test.tsx`を作成
    - 認証済みユーザーのリダイレクトテスト
    - 未認証ユーザーのフォーム表示テスト
    - ローディング状態のテスト
    - _要件: 8.1, 8.2, 8.3_

- [~] 10. チェックポイント - すべてのテストが通過することを確認
  - すべてのテストが通過することを確認し、質問があればユーザーに尋ねる

- [ ] 11. AuthProviderの統合
  - [~] 11.1 ルートレイアウトにAuthProviderを追加
    - `packages/web/src/app/layout.tsx`を更新
    - AuthProviderでchildrenをラップ
    - _要件: 4.3_

- [ ] 12. 環境変数の設定
  - [~] 12.1 環境変数ファイルの作成
    - `.env.local`ファイルを作成（存在しない場合）
    - `NEXT_PUBLIC_API_URL`を設定
    - 開発環境用のデフォルト値を設定
    - _要件: 3.1_

- [~] 13. 最終チェックポイント - 統合テストと動作確認
  - すべてのテストが通過することを確認し、質問があればユーザーに尋ねる

## 注意事項

- `*`マークが付いたタスクはオプションであり、MVP実装時にスキップ可能です
- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントタスクは段階的な検証を保証します
- プロパティベーステストは、設計ドキュメントの正確性プロパティを検証します
- ユニットテストは、特定の例とエッジケースを検証します
- すべてのコンポーネントとサービスは、TypeScriptの厳格モードで実装されます
- shadcn/uiコンポーネントは、アクセシビリティとレスポンシブデザインをサポートします

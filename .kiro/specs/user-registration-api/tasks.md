# 実装計画: ユーザー登録API

## 概要

投票ボードゲームアプリケーションのユーザー登録API機能を実装します。この機能は、新規ユーザーがメールアドレス、パスワード、ユーザー名を使用してアカウントを作成し、Amazon Cognitoで認証され、DynamoDBにプロフィール情報を保存できるようにします。

実装は以下の順序で進めます:

1. インフラストラクチャ（Cognito User Pool、DynamoDB設定）
2. 共通ライブラリ（バリデーション、ユーティリティ）
3. データアクセス層（リポジトリ）
4. サービス層（Cognito統合、レート制限）
5. API層（ルーター、エンドポイント）
6. 統合とテスト

## タスク

- [ ] 1. インフラストラクチャのセットアップ
  - [x] 1.1 Cognito User Poolを作成
    - CDKスタックに`CognitoUserPool`を追加
    - パスワードポリシーを設定（最小8文字、大文字・小文字・数字必須）
    - サインアップ設定（メールアドレスでのサインイン、メール自動確認）
    - アカウント復旧設定（メールのみ）
    - _要件: 5.1, 3.1-3.4_
  - [x] 1.2 Cognito User Pool Clientを作成
    - User Pool Clientを追加
    - 認証フロー設定（USER_PASSWORD_AUTH、USER_SRP_AUTH）
    - クライアントシークレットなし
    - _要件: 5.1, 7.1_
  - [x] 1.3 DynamoDB TTL設定を追加
    - メインテーブルにTTL属性`expiresAt`を設定
    - レート制限レコードの自動削除用
    - _要件: 9.1_
  - [x] 1.4 Lambda環境変数を設定
    - `COGNITO_USER_POOL_ID`を追加
    - `COGNITO_CLIENT_ID`を追加
    - `ALLOWED_ORIGINS`を追加（環境ごとに異なる値）
    - _要件: 11.1-11.4_
  - [x] 1.5 LambdaにCognito権限を付与
    - `cognito-idp:AdminDeleteUser`権限を追加（ロールバック用）
    - _要件: 6.5_
  - [x] 1.6 CDKスタックのスナップショットテストを更新
    - 新しいCognitoリソースのスナップショットを作成
    - DynamoDB TTL設定の検証
    - Lambda環境変数の検証

- [ ] 2. 共通ライブラリの実装
  - [x] 2.1 バリデーションスキーマを作成
    - `packages/api/src/lib/validation/auth-schemas.ts`を作成
    - `registerSchema`を実装（email、password、usernameのバリデーション）
    - メール形式検証（RFC 5322簡易版）
    - パスワード要件検証（8文字以上、大文字・小文字・数字）
    - ユーザー名検証（3-20文字、英数字・ハイフン・アンダースコア）
    - _要件: 1.2-1.5, 2.1, 3.1-3.4, 4.1-4.2_
  - [x] 2.2 バリデーションスキーマのユニットテストを作成
    - 有効なデータの受け入れテスト
    - 無効なメール形式の拒否テスト
    - パスワード要件違反の拒否テスト
    - ユーザー名要件違反の拒否テスト
    - _要件: 1.2-1.5, 2.1-2.2, 3.1-3.5, 4.1-4.3_
  - [x] 2.3 バリデーションスキーマのプロパティテストを作成
    - **プロパティ1: 必須フィールド検証**
    - **検証: 要件 1.2, 1.3, 1.4, 1.5**
  - [x] 2.4 バリデーションスキーマのプロパティテストを作成
    - **プロパティ2: メールアドレス形式検証**
    - **検証: 要件 2.1, 2.2**
  - [x] 2.5 バリデーションスキーマのプロパティテストを作成
    - **プロパティ4: パスワード要件検証**
    - **検証: 要件 3.1, 3.2, 3.3, 3.4, 3.5**
  - [x] 2.6 バリデーションスキーマのプロパティテストを作成
    - **プロパティ5: ユーザー名要件検証**
    - **検証: 要件 4.1, 4.2, 4.3**
  - [x] 2.7 ユーティリティ関数を作成
    - `packages/api/src/lib/utils/mask.ts`を作成
    - `maskEmail`関数を実装（例: <user@example.com> → u\*\*\*@example.com）
    - `maskPassword`関数を実装（常に**\*\*\*\***を返す）
    - _要件: 12.1, 12.4_
  - [x] 2.8 ユーティリティ関数のユニットテストを作成
    - メールマスキングのテスト
    - パスワードマスキングのテスト

- [x] 3. チェックポイント - 基礎実装の確認
  - すべてのテストが通過することを確認し、質問があればユーザーに確認してください。

- [ ] 4. データアクセス層の実装
  - [x] 4.1 BaseRepositoryを作成
    - `packages/api/src/lib/dynamodb/repositories/base.ts`を作成
    - DynamoDBDocumentClientの初期化
    - 共通メソッド（`now()`など）を実装
    - _要件: 6.1_
  - [x] 4.2 UserRepositoryを作成
    - `packages/api/src/lib/dynamodb/repositories/user.ts`を作成
    - `UserEntity`インターフェースを定義
    - `create`メソッドを実装（PutCommandで条件付き書き込み）
    - `getById`メソッドを実装（GetCommand）
    - _要件: 6.1-6.4_
  - [x] 4.3 UserRepositoryのユニットテストを作成
    - `create`メソッドのテスト（成功ケース）
    - `create`メソッドのテスト（重複エラー）
    - `getById`メソッドのテスト
    - DynamoDBクライアントをモック
    - _要件: 6.1-6.4_
  - [x] 4.4 UserRepositoryのプロパティテストを作成
    - **プロパティ8: DynamoDBユーザーレコード作成**
    - **検証: 要件 6.1, 6.2, 6.3, 6.4**

- [ ] 5. サービス層の実装
  - [x] 5.1 CognitoServiceを作成
    - `packages/api/src/lib/cognito/cognito-service.ts`を作成
    - `SignUpResult`と`AuthTokens`インターフェースを定義
    - `signUp`メソッドを実装（SignUpCommand）
    - `authenticate`メソッドを実装（InitiateAuthCommand）
    - `deleteUser`メソッドを実装（AdminDeleteUserCommand、ロールバック用）
    - _要件: 5.1-5.4, 7.1-7.4_
  - [x] 5.2 CognitoServiceのユニットテストを作成
    - `signUp`メソッドのテスト（成功ケース）
    - `signUp`メソッドのテスト（UsernameExistsException）
    - `authenticate`メソッドのテスト（成功ケース）
    - `deleteUser`メソッドのテスト
    - Cognitoクライアントをモック
    - _要件: 5.1-5.4, 7.1-7.4_
  - [x] 5.3 CognitoServiceのプロパティテストを作成
    - **プロパティ6: Cognitoユーザー作成**
    - **検証: 要件 5.1, 5.2, 5.4**
  - [x] 5.4 CognitoServiceのプロパティテストを作成
    - **プロパティ7: Cognitoエラーハンドリング**
    - **検証: 要件 5.3**
  - [x] 5.5 CognitoServiceのプロパティテストを作成
    - **プロパティ10: 認証トークン取得**
    - **検証: 要件 7.1, 7.2, 7.3, 7.4**
  - [x] 5.6 RateLimiterを作成
    - `packages/api/src/lib/rate-limiter.ts`を作成
    - `RateLimitRecord`インターフェースを定義
    - `checkLimit`メソッドを実装（1分あたり5リクエスト）
    - `getRetryAfter`メソッドを実装
    - DynamoDBでカウンター管理（スライディングウィンドウ）
    - _要件: 9.1-9.3_
  - [x] 5.7 RateLimiterのユニットテストを作成
    - `checkLimit`メソッドのテスト（制限内）
    - `checkLimit`メソッドのテスト（制限超過）
    - `getRetryAfter`メソッドのテスト
    - DynamoDBクライアントをモック
    - _要件: 9.1-9.3_
  - [x] 5.8 RateLimiterのプロパティテストを作成
    - **プロパティ12: レート制限**
    - **検証: 要件 9.1, 9.2, 9.3**

- [x] 6. チェックポイント - サービス層の確認
  - すべてのテストが通過することを確認し、質問があればユーザーに確認してください。

- [ ] 7. API層の実装
  - [x] 7.1 Auth Routerを作成
    - `packages/api/src/routes/auth.ts`を作成
    - Honoルーターを初期化
    - POST `/auth/register`エンドポイントを実装
    - Zodバリデーターを統合（`zValidator`）
    - レート制限チェックを実装
    - リクエストログを実装（マスク済みメールアドレス、IPアドレス）
    - _要件: 1.1, 1.2-1.5, 9.1-9.3, 12.1_
  - [x] 7.2 登録フローを実装
    - Cognitoユーザー作成を呼び出し
    - DynamoDBユーザーレコード作成を呼び出し
    - 認証トークン取得を呼び出し
    - 成功レスポンスを返す（201、userId、email、username、tokens）
    - _要件: 5.1-5.4, 6.1-6.4, 7.1-7.4, 8.1-8.4_
  - [x] 7.3 エラーハンドリングを実装
    - UsernameExistsException → 409 CONFLICT
    - InvalidPasswordException → 400 VALIDATION_ERROR
    - DynamoDB書き込みエラー → Cognitoユーザー削除（ロールバック）→ 500 INTERNAL_ERROR
    - その他のエラー → 500 INTERNAL_ERROR
    - エラーログを実装（マスク済みデータ）
    - _要件: 2.3, 3.5, 5.3, 6.5, 10.1-10.4, 12.3_
  - [x] 7.4 CORS設定を実装
    - 環境変数`ALLOWED_ORIGINS`から許可オリジンを取得
    - HonoミドルウェアでCORSヘッダーを設定
    - POSTメソッドとContent-Typeヘッダーを許可
    - _要件: 11.1-11.5_
  - [x] 7.5 Auth Routerのユニットテストを作成
    - 有効なリクエストの成功テスト
    - バリデーションエラーのテスト
    - メール重複エラーのテスト
    - レート制限エラーのテスト
    - Cognitoエラーのテスト
    - DynamoDBエラー＋ロールバックのテスト
    - サービスをモック
    - _要件: 1.1-1.5, 2.1-2.3, 3.1-3.5, 4.1-4.3, 5.1-5.4, 6.1-6.5, 7.1-7.4, 8.1-8.4, 9.1-9.3, 10.1-10.4_
  - [x] 7.6 Auth Routerのプロパティテストを作成
    - **プロパティ3: メールアドレス重複検証（冪等性）**
    - **検証: 要件 2.3, 13.1, 13.2, 13.3**
  - [x] 7.7 Auth Routerのプロパティテストを作成
    - **プロパティ9: トランザクション整合性（ロールバック）**
    - **検証: 要件 6.5**
  - [x] 7.8 Auth Routerのプロパティテストを作成
    - **プロパティ11: 成功レスポンス形式**
    - **検証: 要件 8.1, 8.2, 8.3, 8.4**
  - [x] 7.9 Auth Routerのプロパティテストを作成
    - **プロパティ13: エラーレスポンス形式**
    - **検証: 要件 10.1, 10.2, 10.3, 10.4**
  - [x] 7.10 Auth Routerのプロパティテストを作成
    - **プロパティ14: CORS設定**
    - **検証: 要件 11.1, 11.2, 11.3, 11.4, 11.5**

- [ ] 8. 統合とワイヤリング
  - [~] 8.1 メインアプリケーションにAuth Routerを統合
    - `packages/api/src/index.ts`にAuth Routerをインポート
    - `/auth`パスでAuth Routerをマウント
    - グローバルエラーハンドラーを追加（未処理エラー用）
    - _要件: 1.1_
  - [~] 8.2 エンドツーエンド統合テストを作成
    - 登録成功フローのテスト（実際のHonoアプリを使用）
    - 登録失敗フローのテスト（バリデーションエラー）
    - 登録失敗フローのテスト（メール重複）
    - レート制限のテスト
    - サービスをモック（Cognito、DynamoDB）
    - _要件: 1.1-1.5, 2.1-2.3, 3.1-3.5, 4.1-4.3, 5.1-5.4, 6.1-6.5, 7.1-7.4, 8.1-8.4, 9.1-9.3_

- [~] 9. 最終チェックポイント - 統合テスト
  - すべてのテストが通過することを確認し、質問があればユーザーに確認してください。

## 注意事項

- `*`マークのタスクはオプションであり、より速いMVPのためにスキップ可能です
- 各タスクは特定の要件を参照してトレーサビリティを確保しています
- チェックポイントは段階的な検証を保証します
- プロパティテストは普遍的な正確性プロパティを検証します
- ユニットテストは特定の例とエッジケースを検証します
- 実装は既存のコードベースパターン（Hono、Zod、AWS SDK v3）に従います
- すべてのコードは日本語のコメントとログメッセージを使用します
